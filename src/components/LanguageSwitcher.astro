---
import { t } from "@locales";
import { buildDetailPageUrl, buildHomeUrl, buildStaticPageUrl, isHomePage } from "@utils/translation-url";

interface Props {
  lang: "es" | "en";
  translationSlug?: string; // Slug of the translated version (from i18n field)
  disabled?: boolean; // True if translation doesn't exist
}

const { lang, translationSlug, disabled = false } = Astro.props;

// Determine target language
const targetLang = lang === "es" ? "en" : "es";
const currentPath = Astro.url.pathname;

// Build translated URL using the translationSlug if provided
function getTranslatedUrl(): string {
  const pathParts = currentPath.split("/").filter(Boolean);

  // Home page
  if (isHomePage(pathParts)) {
    return buildHomeUrl(targetLang);
  }

  // pathParts: ["es", "libros", "slug"] or ["en", "books", "slug"]
  const currentLang = pathParts[0];
  const localizedSegment = pathParts[1];

  // Detail page with translation slug
  if (translationSlug) {
    return buildDetailPageUrl(localizedSegment, translationSlug, currentLang, targetLang);
  }

  // Static or listing page without translation slug
  return buildStaticPageUrl(pathParts, currentLang, targetLang);
}

const translatedUrl = disabled ? "#" : getTranslatedUrl();

// Flag emoji and alt text
const flagEmoji = targetLang === "es" ? "ðŸ‡ªðŸ‡¸" : "ðŸ‡¬ðŸ‡§";
const flagLabel = t(lang, targetLang === "es" ? "menu.toSpanish" : "menu.toEnglish");
---

<div class:list={["language-switcher", { "language-switcher--disabled": disabled }]}>
  {
    disabled ? (
      <span class="language-switcher__flag" title={flagLabel} aria-label={flagLabel}>
        {flagEmoji}
      </span>
    ) : (
      <a
        href={translatedUrl}
        class="language-switcher__link"
        title={flagLabel}
        aria-label={flagLabel}
        data-astro-reload
      >
        <span class="language-switcher__flag">{flagEmoji}</span>
      </a>
    )
  }
</div>

<script>
  // Preserve hash and query params when switching languages
  // This runs on the client side to capture hash fragments (which aren't sent to server)
  function setupLanguageSwitcher() {
    const languageSwitcherLink = document.querySelector(".language-switcher__link");

    if (!languageSwitcherLink) return;

    // Remove any existing listener to avoid duplicates
    const existingHandler = languageSwitcherLink.__langSwitchHandler;
    if (existingHandler) {
      languageSwitcherLink.removeEventListener("click", existingHandler);
    }

    // Create new handler
    const handler = (e) => {
      const currentSearch = window.location.search;
      const currentHash = window.location.hash;

      if (currentSearch || currentHash) {
        e.preventDefault();
        const baseHref = languageSwitcherLink.getAttribute("href");
        const newHref = baseHref + currentSearch + currentHash;
        window.location.href = newHref;
      }
    };

    // Store handler reference and add listener
    languageSwitcherLink.__langSwitchHandler = handler;
    languageSwitcherLink.addEventListener("click", handler);

    // Mark as ready for E2E tests
    languageSwitcherLink.setAttribute("data-lang-switcher-ready", "true");
  }

  // Run on initial load and after each View Transition
  document.addEventListener("astro:page-load", setupLanguageSwitcher);
</script>

<style lang="scss">
  @use "../styles/mixins" as *;

  .language-switcher {
    line-height: 1;
    display: inline-flex;
    align-items: center;

    &__flag {
      font-size: 20px;
      display: block;
      user-select: none;
      line-height: 1;

      // Desktop: Slightly larger for better visibility
      @include small-and-up {
        font-size: 22px;
      }
    }

    &__link {
      text-decoration: none;
      transition: transform 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      // Mobile: Large touch targets (WCAG 2.1 Level AAA: 44x44px)
      min-width: 44px;
      min-height: 44px;
      padding: 10px;

      // Desktop: More compact
      @include small-and-up {
        min-width: auto;
        min-height: auto;
        padding: 4px;
      }

      &:hover {
        transform: scale(1.15);
      }
    }

    &--disabled {
      .language-switcher__flag {
        filter: grayscale(100%) opacity(0.5);
        cursor: not-allowed;
      }
    }
  }
</style>
