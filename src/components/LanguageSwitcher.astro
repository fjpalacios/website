---
import { t } from "@locales";
import { buildDetailPageUrl, buildHomeUrl, buildStaticPageUrl, isHomePage } from "@utils/translation-url";

interface Props {
  lang: "es" | "en";
  translationSlug?: string; // Slug of the translated version (from i18n field)
  disabled?: boolean; // True if translation doesn't exist
}

const { lang, translationSlug, disabled = false } = Astro.props;

// Determine target language
const targetLang = lang === "es" ? "en" : "es";
const currentPath = Astro.url.pathname;

// Build translated URL using the translationSlug if provided
function getTranslatedUrl(): string {
  const pathParts = currentPath.split("/").filter(Boolean);

  // Home page
  if (isHomePage(pathParts)) {
    return buildHomeUrl(targetLang);
  }

  // pathParts: ["es", "libros", "slug"] or ["en", "books", "slug"]
  const currentLang = pathParts[0];
  const localizedSegment = pathParts[1];

  // Detail page with translation slug
  if (translationSlug) {
    return buildDetailPageUrl(localizedSegment, translationSlug, currentLang, targetLang);
  }

  // Static or listing page without translation slug
  return buildStaticPageUrl(pathParts, currentLang, targetLang);
}

const translatedUrl = disabled ? "#" : getTranslatedUrl();

// Flag emoji and alt text
const flagEmoji = targetLang === "es" ? "ðŸ‡ªðŸ‡¸" : "ðŸ‡¬ðŸ‡§";
const flagLabel = t(lang, targetLang === "es" ? "menu.toSpanish" : "menu.toEnglish");
---

<div class:list={["language-switcher", { "language-switcher--disabled": disabled }]}>
  {
    disabled ? (
      <span class="language-switcher__flag" title={flagLabel} aria-label={flagLabel}>
        {flagEmoji}
      </span>
    ) : (
      <a href={translatedUrl} class="language-switcher__link" title={flagLabel} aria-label={flagLabel}>
        <span class="language-switcher__flag">{flagEmoji}</span>
      </a>
    )
  }
</div>

<style lang="scss">
  .language-switcher {
    line-height: 1;
    display: inline-flex;
    align-items: center;

    &__flag {
      font-size: 16px;
      display: block;
      user-select: none;
    }

    &__link {
      text-decoration: none;
      transition: transform 0.2s ease;

      &:hover {
        transform: scale(1.15);
      }
    }

    &--disabled {
      .language-switcher__flag {
        filter: grayscale(100%) opacity(0.5);
        cursor: not-allowed;
      }
    }
  }
</style>
