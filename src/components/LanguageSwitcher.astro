---
import { t } from "@locales";

interface Props {
  lang: "es" | "en";
  translationSlug?: string; // Slug of the translated version (from i18n field)
  disabled?: boolean; // True if translation doesn't exist
}

const { lang, translationSlug, disabled = false } = Astro.props;

// Determine target language
const targetLang = lang === "es" ? "en" : "es";
const currentPath = Astro.url.pathname;

// Build translated URL using the translationSlug if provided
function getTranslatedUrl(): string {
  if (!translationSlug) {
    // No translation slug provided, just change language prefix (for static pages like home, about)
    const pathParts = currentPath.split("/").filter(Boolean);

    if (pathParts.length === 0) {
      return `/${targetLang}`;
    }

    // Replace language prefix
    pathParts[0] = targetLang;

    // Translate content type paths if needed
    if (pathParts.length >= 2) {
      const contentType = pathParts[1];

      // Map content types between languages (all plural now)
      const contentTypeMap: Record<string, string> = {
        posts: "posts",
        tutorials: "tutorials",
        books: "books",
        categories: "categories",
        genres: "genres",
        publishers: "publishers",
        series: "series",
        challenges: "challenges",
      };

      pathParts[1] = contentTypeMap[contentType] || contentType;
    }

    return `/${pathParts.join("/")}`;
  }

  // We have a translation slug, build the proper URL
  const pathParts = currentPath.split("/").filter(Boolean);

  // pathParts: ["es", "blog", "slug"] or ["en", "tutorials", "slug"]
  if (pathParts.length >= 2) {
    const contentType = pathParts[1];

    // Map content types to translated paths (all plural, same in both languages)
    const contentTypeMap: Record<string, Record<string, string>> = {
      posts: { es: "posts", en: "posts" },
      tutorials: { es: "tutorials", en: "tutorials" },
      books: { es: "books", en: "books" },
      categories: { es: "categories", en: "categories" },
      genres: { es: "genres", en: "genres" },
      publishers: { es: "publishers", en: "publishers" },
      series: { es: "series", en: "series" },
      challenges: { es: "challenges", en: "challenges" },
    };

    const translatedType = contentTypeMap[contentType]?.[targetLang] || contentType;
    return `/${targetLang}/${translatedType}/${translationSlug}`;
  }

  // Fallback
  return `/${targetLang}`;
}

const translatedUrl = disabled ? "#" : getTranslatedUrl();

// Flag emoji and alt text
const flagEmoji = targetLang === "es" ? "ðŸ‡ªðŸ‡¸" : "ðŸ‡¬ðŸ‡§";
const flagLabel = t(lang, targetLang === "es" ? "menu.toSpanish" : "menu.toEnglish");
---

<div class:list={["language-switcher", { "language-switcher--disabled": disabled }]}>
  {
    disabled ? (
      <span class="language-switcher__flag" title={flagLabel} aria-label={flagLabel}>
        {flagEmoji}
      </span>
    ) : (
      <a href={translatedUrl} class="language-switcher__link" title={flagLabel} aria-label={flagLabel}>
        <span class="language-switcher__flag">{flagEmoji}</span>
      </a>
    )
  }
</div>

<style lang="scss">
  .language-switcher {
    line-height: 1;
    display: inline-flex;
    align-items: center;

    &__flag {
      font-size: 16px;
      display: block;
      user-select: none;
    }

    &__link {
      text-decoration: none;
      transition: transform 0.2s ease;

      &:hover {
        transform: scale(1.15);
      }
    }

    &--disabled {
      .language-switcher__flag {
        filter: grayscale(100%) opacity(0.5);
        cursor: not-allowed;
      }
    }
  }
</style>
