---
import { t } from "@locales";
import { getCanonicalSegment, getLocalizedRoute, type RouteSegment } from "@utils/routes";

interface Props {
  lang: "es" | "en";
  translationSlug?: string; // Slug of the translated version (from i18n field)
  disabled?: boolean; // True if translation doesn't exist
}

const { lang, translationSlug, disabled = false } = Astro.props;

// Determine target language
const targetLang = lang === "es" ? "en" : "es";
const currentPath = Astro.url.pathname;

// Build translated URL using the translationSlug if provided
function getTranslatedUrl(): string {
  const pathParts = currentPath.split("/").filter(Boolean);

  if (pathParts.length === 0) {
    return `/${targetLang}`;
  }

  // pathParts: ["es", "libros", "slug"] or ["en", "books", "slug"]
  const currentLang = pathParts[0];
  const localizedSegment = pathParts[1];

  if (!translationSlug) {
    // No translation slug = static page or listing page
    // Static pages (home, about) and listing pages (books index, tutorials index) always have translations

    if (pathParts.length === 1) {
      // Home page: /es â†’ /en
      return `/${targetLang}`;
    }

    // Get canonical segment from localized path
    const canonicalSegment = getCanonicalSegment(localizedSegment, currentLang);

    if (!canonicalSegment) {
      // Unknown segment, just swap language
      return `/${targetLang}/${localizedSegment}`;
    }

    // Translate to target language
    const translatedSegment = getLocalizedRoute(canonicalSegment as RouteSegment, targetLang);

    // Rebuild path with remaining segments
    const remainingParts = pathParts.slice(2);
    return `/${targetLang}/${translatedSegment}${remainingParts.length ? "/" + remainingParts.join("/") : ""}`;
  }

  // We have a translation slug = detail page (post, tutorial, book)
  // Get canonical segment from current localized path
  const canonicalSegment = getCanonicalSegment(localizedSegment, currentLang);

  if (!canonicalSegment) {
    // Fallback if we can't determine the content type
    return `/${targetLang}`;
  }

  // Translate to target language
  const translatedSegment = getLocalizedRoute(canonicalSegment as RouteSegment, targetLang);

  return `/${targetLang}/${translatedSegment}/${translationSlug}`;
}

const translatedUrl = disabled ? "#" : getTranslatedUrl();

// Flag emoji and alt text
const flagEmoji = targetLang === "es" ? "ðŸ‡ªðŸ‡¸" : "ðŸ‡¬ðŸ‡§";
const flagLabel = t(lang, targetLang === "es" ? "menu.toSpanish" : "menu.toEnglish");
---

<div class:list={["language-switcher", { "language-switcher--disabled": disabled }]}>
  {
    disabled ? (
      <span class="language-switcher__flag" title={flagLabel} aria-label={flagLabel}>
        {flagEmoji}
      </span>
    ) : (
      <a href={translatedUrl} class="language-switcher__link" title={flagLabel} aria-label={flagLabel}>
        <span class="language-switcher__flag">{flagEmoji}</span>
      </a>
    )
  }
</div>

<style lang="scss">
  .language-switcher {
    line-height: 1;
    display: inline-flex;
    align-items: center;

    &__flag {
      font-size: 16px;
      display: block;
      user-select: none;
    }

    &__link {
      text-decoration: none;
      transition: transform 0.2s ease;

      &:hover {
        transform: scale(1.15);
      }
    }

    &--disabled {
      .language-switcher__flag {
        filter: grayscale(100%) opacity(0.5);
        cursor: not-allowed;
      }
    }
  }
</style>
