---
/**
 * LatestPosts Component
 *
 * Displays the N most recent blog posts (books, posts, tutorials) for the current language.
 * Used on homepage to show recent activity.
 *
 * Features:
 * - Queries all content types (books, posts, tutorials)
 * - Filters by current page language
 * - Sorts by date DESC
 * - Displays title, date (vintage format), and excerpt
 * - Hidden in print view (for CV generation)
 * - Uses BEM methodology for styling
 *
 * @component
 * @param {number} limit - Number of posts to display (default: 4)
 * @param {string} lang - Language code ('es' | 'en')
 */

import Title from "@components/Title.astro";
import { t } from "@locales";
import { filterByLanguage } from "@utils/blog";
import type { PostSummary } from "@utils/blog";
import { formatVintageDate } from "@utils/dateFormat";
import { buildBookUrl, buildPostUrl, buildTutorialUrl } from "@utils/routes";
import { getCollection } from "astro:content";

interface Props {
  limit?: number;
  lang: "es" | "en";
}

const { limit = 4, lang } = Astro.props;

/**
 * Get all content for the current language, sorted by date
 */
async function getLatestPosts(language: string, maxItems: number): Promise<PostSummary[]> {
  // Get all content types
  const allPosts = await getCollection("posts");
  const allTutorials = await getCollection("tutorials");
  const allBooks = await getCollection("books");

  // Filter by language and exclude drafts
  const langPosts = filterByLanguage(allPosts, language).filter((post) => !post.data.draft);
  const langTutorials = filterByLanguage(allTutorials, language).filter((tutorial) => !tutorial.data.draft);
  const langBooks = filterByLanguage(allBooks, language);

  // Prepare combined content with unified structure
  const combinedContent: PostSummary[] = [
    ...langPosts.map((post) => ({
      type: "post" as const,
      slug: post.data.post_slug,
      title: post.data.title,
      date: post.data.date,
      excerpt: post.data.excerpt,
      language: post.data.language,
      cover: post.data.cover || post.data.featured_image,
    })),
    ...langTutorials.map((tutorial) => ({
      type: "tutorial" as const,
      slug: tutorial.data.post_slug,
      title: tutorial.data.title,
      date: tutorial.data.date,
      excerpt: tutorial.data.excerpt,
      language: tutorial.data.language,
      cover: tutorial.data.cover || tutorial.data.featured_image,
    })),
    ...langBooks.map((book) => ({
      type: "book" as const,
      slug: book.data.post_slug,
      title: book.data.title,
      date: book.data.date,
      excerpt: book.data.excerpt,
      language: book.data.language,
      cover: book.data.cover,
    })),
  ];

  // Sort by date (newest first) and limit
  return combinedContent
    .sort((a, b) => {
      const dateA = new Date(a.date);
      const dateB = new Date(b.date);
      return dateB.getTime() - dateA.getTime();
    })
    .slice(0, maxItems);
}

/**
 * Get the correct URL based on content type
 */
function getContentUrl(item: PostSummary): string {
  switch (item.type) {
    case "book":
      return buildBookUrl(item.language, item.slug);
    case "tutorial":
      return buildTutorialUrl(item.language, item.slug);
    case "post":
    default:
      return buildPostUrl(item.language, item.slug);
  }
}

// Fetch latest posts
const latestPosts = await getLatestPosts(lang, limit);
---

{
  latestPosts.length > 0 && (
    <main class="latest-posts">
      <Title title={t(lang, "latestBlogPosts")} />
      <section class="latest-posts__list">
        {latestPosts.map((post) => {
          const url = getContentUrl(post);
          const formattedDate = formatVintageDate(post.date, lang);

          return (
            <section class="latest-posts__list__post">
              <section class="latest-posts__list__post__title">
                <a href={url}>{post.title}</a>
              </section>
              <section class="latest-posts__list__post__date">
                <time datetime={formattedDate.datetime} aria-label={formattedDate.aria}>
                  {formattedDate.visual}
                </time>
              </section>
              <section class="latest-posts__list__post__excerpt">{post.excerpt}</section>
            </section>
          );
        })}
      </section>
    </main>
  )
}
