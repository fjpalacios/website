---
import Icon from "@components/Icon.astro";
import LanguageSwitcher from "@components/LanguageSwitcher.astro";
import { getMenuItems, hasContentInLanguage } from "@config/navigation";
import { t } from "@locales";
import { buildLocalizedPath } from "@utils/routes";
import { hasTranslation as checkTranslationAvailability } from "@utils/translation-availability";

interface Props {
  lang: string;
  currentPath: string;
  translationSlug?: string; // Slug of the translated version
  hasTargetContent?: boolean; // Whether target language has content (for index pages)
}

const { lang, currentPath, translationSlug, hasTargetContent } = Astro.props;

// Determine if translation exists
const hasTranslation = checkTranslationAvailability(currentPath, lang, translationSlug, hasTargetContent);

// Build navigation items with URLs and active states
const menuItems = getMenuItems(lang);

// Filter items based on content availability
const filteredMenuItems = await Promise.all(
  menuItems.map(async (item) => {
    const hasContent = await hasContentInLanguage(item.routeKey, lang);
    return hasContent ? item : null;
  }),
);

const itemsWithUrls = filteredMenuItems
  .filter((item) => item !== null)
  .map((item) => {
    const url = item.routeKey === "home" ? `/${lang}` : buildLocalizedPath(lang, item.routeKey);
    const isActive =
      item.matchStrategy === "exact" ? currentPath === url || currentPath === `${url}/` : currentPath.startsWith(url);

    return {
      ...item,
      url,
      label: t(lang, `pages.${item.id}`),
      isActive,
    };
  });
---

<nav class="menu">
  <div class="menu__left">
    <LanguageSwitcher lang={lang} translationSlug={translationSlug} disabled={!hasTranslation} />
    <button
      type="button"
      class="theme-switcher"
      id="theme-toggle"
      aria-label={t(lang, "menu.switchTheme")}
      title={t(lang, "menu.switchTheme")}
    >
      <Icon name="sun" size="md" class="theme-switcher__icon theme-switcher__icon--sun" />
      <Icon name="moon" size="md" class="theme-switcher__icon theme-switcher__icon--moon" />
    </button>
    <button
      type="button"
      class="search-button"
      id="search-toggle"
      aria-label={t(lang, "menu.search")}
      title={t(lang, "menu.search")}
    >
      <Icon name="search" size="md" class="search-button__icon" />
    </button>
  </div>
  <div class="menu__right">
    <ul class="navigation">
      {
        itemsWithUrls.map((item) => (
          <li class="navigation__link">
            <a href={item.url} class:list={[{ "navigation__link--active": item.isActive }]}>
              {item.label}
            </a>
          </li>
        ))
      }
    </ul>
  </div>
</nav>

<script>
  import { initTheme } from "@scripts/theme";

  // Initialize theme on page load and after view transitions
  document.addEventListener("astro:page-load", () => {
    initTheme();
  });
</script>
