---
import LanguageSwitcher from "@components/LanguageSwitcher.astro";
import { t } from "@locales";
import { buildLocalizedPath } from "@utils/routes";

interface Props {
  lang: string;
  currentPath: string;
  translationSlug?: string; // Slug of the translated version
  hasTargetContent?: boolean; // Whether target language has content (for index pages)
}

const { lang, currentPath, translationSlug, hasTargetContent } = Astro.props;

// Determine if translation exists based on translationSlug and hasTargetContent
// Rules:
// 1. Static pages (home, about) always have translation available
// 2. Index/listing pages check hasTargetContent (if provided) to know if target language has content
// 3. Content detail pages depend on translationSlug being provided
// 4. Taxonomy detail pages depend on translationSlug being provided

// Check if it's a static page (home, about)
const isHomePage = currentPath === `/${lang}` || currentPath === `/${lang}/`;
const isAboutPage = currentPath.includes(`/${t(lang, "routes.about")}`);
const isStaticPage = isHomePage || isAboutPage;

// Check if it's an index/listing page (ends with a route segment, no slug after)
const indexRoutes = [
  `/${lang}/${t(lang, "routes.posts")}`,
  `/${lang}/${t(lang, "routes.tutorials")}`,
  `/${lang}/${t(lang, "routes.books")}`,
  `/${lang}/${t(lang, "routes.feeds")}`,
  `/${lang}/${t(lang, "routes.authors")}`,
  `/${lang}/${t(lang, "routes.categories")}`,
  `/${lang}/${t(lang, "routes.genres")}`,
  `/${lang}/${t(lang, "routes.publishers")}`,
  `/${lang}/${t(lang, "routes.series")}`,
  `/${lang}/${t(lang, "routes.challenges")}`,
  `/${lang}/${t(lang, "routes.courses")}`,
];

const isIndexPage = indexRoutes.some((route) => currentPath === route || currentPath === `${route}/`);

// Determine if translation is available
let hasTranslation = true;

if (isStaticPage) {
  // Static pages always have translation
  hasTranslation = true;
} else if (isIndexPage) {
  // Index pages check if target language has content
  // If hasTargetContent is not provided, assume translation exists (backward compatibility)
  hasTranslation = hasTargetContent !== undefined ? hasTargetContent : true;
} else {
  // Detail pages depend on translationSlug
  hasTranslation = translationSlug !== undefined;
}

const homeUrl = `/${lang}`;
const aboutUrl = buildLocalizedPath(lang, "about");
const postsUrl = buildLocalizedPath(lang, "posts");
const tutorialsUrl = buildLocalizedPath(lang, "tutorials");
const booksUrl = buildLocalizedPath(lang, "books");
const feedsUrl = buildLocalizedPath(lang, "feeds");
const categoriesUrl = buildLocalizedPath(lang, "categories");
const genresUrl = buildLocalizedPath(lang, "genres");
const publishersUrl = buildLocalizedPath(lang, "publishers");
const seriesUrl = buildLocalizedPath(lang, "series");
const challengesUrl = buildLocalizedPath(lang, "challenges");
const authorsUrl = buildLocalizedPath(lang, "authors");
const coursesUrl = buildLocalizedPath(lang, "courses");
---

<nav class="menu">
  <div class="menu__left">
    <LanguageSwitcher lang={lang} translationSlug={translationSlug} disabled={!hasTranslation} />
    <button
      type="button"
      class="theme-switcher"
      id="theme-toggle"
      aria-label={t(lang, "menu.switchTheme")}
      title={t(lang, "menu.switchTheme")}
    >
      <span class="theme-switcher__icon" aria-hidden="true"></span>
    </button>
    <button
      type="button"
      class="search-button"
      id="search-toggle"
      aria-label={t(lang, "menu.search")}
      title={t(lang, "menu.search")}
    >
      <span class="search-button__icon" aria-hidden="true">üîç</span>
    </button>
  </div>
  <div class="menu__right">
    <ul class="navigation">
      <li class="navigation__link">
        <a
          href={homeUrl}
          class:list={[{ "navigation__link--active": currentPath === homeUrl || currentPath === `${homeUrl}/` }]}
        >
          {t(lang, "pages.home")}
        </a>
      </li>
      <li class="navigation__link">
        <a
          href={aboutUrl}
          class:list={[{ "navigation__link--active": currentPath === aboutUrl || currentPath === `${aboutUrl}/` }]}
        >
          {t(lang, "pages.about")}
        </a>
      </li>
      <li class="navigation__link">
        <a href={postsUrl} class:list={[{ "navigation__link--active": currentPath.startsWith(postsUrl) }]}>
          {t(lang, "pages.posts")}
        </a>
      </li>
      <li class="navigation__link">
        <a href={tutorialsUrl} class:list={[{ "navigation__link--active": currentPath.startsWith(tutorialsUrl) }]}>
          {t(lang, "pages.tutorials")}
        </a>
      </li>
      <li class="navigation__link">
        <a href={booksUrl} class:list={[{ "navigation__link--active": currentPath.startsWith(booksUrl) }]}>
          {t(lang, "pages.books")}
        </a>
      </li>
      <li class="navigation__link">
        <a href={feedsUrl} class:list={[{ "navigation__link--active": currentPath.startsWith(feedsUrl) }]}>
          {t(lang, "pages.feeds")}
        </a>
      </li>
      <li class="navigation__link">
        <a href={categoriesUrl} class:list={[{ "navigation__link--active": currentPath.startsWith(categoriesUrl) }]}>
          {t(lang, "pages.categories")}
        </a>
      </li>
      <li class="navigation__link">
        <a href={genresUrl} class:list={[{ "navigation__link--active": currentPath.startsWith(genresUrl) }]}>
          {t(lang, "pages.genres")}
        </a>
      </li>
      <li class="navigation__link">
        <a href={publishersUrl} class:list={[{ "navigation__link--active": currentPath.startsWith(publishersUrl) }]}>
          {t(lang, "pages.publishers")}
        </a>
      </li>
      <li class="navigation__link">
        <a href={seriesUrl} class:list={[{ "navigation__link--active": currentPath.startsWith(seriesUrl) }]}>
          {t(lang, "pages.series")}
        </a>
      </li>
      <li class="navigation__link">
        <a href={challengesUrl} class:list={[{ "navigation__link--active": currentPath.startsWith(challengesUrl) }]}>
          {t(lang, "pages.challenges")}
        </a>
      </li>
      <li class="navigation__link">
        <a href={authorsUrl} class:list={[{ "navigation__link--active": currentPath.startsWith(authorsUrl) }]}>
          {t(lang, "pages.authors")}
        </a>
      </li>
      <li class="navigation__link">
        <a href={coursesUrl} class:list={[{ "navigation__link--active": currentPath.startsWith(coursesUrl) }]}>
          {t(lang, "pages.courses")}
        </a>
      </li>
    </ul>
  </div>
</nav>

<script is:inline>
  // Update theme icon immediately after menu renders (prevents icon flash)
  (function () {
    const theme = localStorage.getItem("theme") || "dark";
    const icon = document.querySelector(".theme-switcher__icon");
    if (icon) {
      icon.textContent = theme === "dark" ? "‚òÄÔ∏è" : "üåë";
    }
  })();
</script>

<script>
  import { initTheme } from "@scripts/theme";

  // Initialize theme on page load and after view transitions
  document.addEventListener("astro:page-load", () => {
    initTheme();
  });
</script>
