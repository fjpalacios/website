---
/**
 * OptimizedImage Component
 *
 * Automatically optimizes images using Astro's built-in image optimization.
 *
 * Features:
 * - Automatic format conversion (WebP/AVIF)
 * - Responsive images with srcset
 * - Lazy loading by default
 * - Quality optimization
 * - Automatic width/height inference
 *
 * Usage:
 *
 * With imported image (recommended for build-time optimization):
 * ```astro
 * import bookCover from '@/assets/books/el-hobbit.jpg';
 * <OptimizedImage src={bookCover} alt="El Hobbit" />
 * ```
 *
 * With public path (for dynamic/CMS images):
 * ```astro
 * <OptimizedImage src="/images/books/el-hobbit.jpg" alt="El Hobbit" width={300} height={450} />
 * ```
 *
 * With custom sizes (for responsive images):
 * ```astro
 * <OptimizedImage
 *   src={bookCover}
 *   alt="Book cover"
 *   sizes="(max-width: 768px) 100vw, 50vw"
 * />
 * ```
 */

import type { ImageMetadata } from "astro";
import { Image } from "astro:assets";
import "@styles/components/optimized-image.scss";

interface Props {
  /**
   * Image source - can be:
   * - Imported ImageMetadata (recommended): import cover from '@/assets/books/cover.jpg'
   * - Public path string: '/images/books/cover.jpg'
   */
  src: ImageMetadata | string;

  /**
   * Alt text for accessibility (required)
   */
  alt: string;

  /**
   * Image width in pixels
   * - Required for public path images
   * - Optional for imported images (inferred automatically)
   */
  width?: number;

  /**
   * Image height in pixels
   * - Required for public path images
   * - Optional for imported images (inferred automatically)
   */
  height?: number;

  /**
   * CSS class for styling
   */
  class?: string;

  /**
   * Loading strategy
   * - 'lazy' (default): Load when near viewport
   * - 'eager': Load immediately
   */
  loading?: "lazy" | "eager";

  /**
   * Image format
   * - 'webp' (default): Good compatibility, ~70% smaller
   * - 'avif': Better compression, newer format
   * - undefined: Keep original format
   */
  format?: "webp" | "avif" | "jpeg" | "png";

  /**
   * Image quality (1-100)
   * - Default: 80 (good balance of quality/size)
   * - Higher = better quality, larger file
   */
  quality?: number;

  /**
   * Responsive image sizes
   *
   * Examples:
   * - "(max-width: 768px) 100vw, 50vw"
   * - "(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw"
   *
   * See: https://developer.mozilla.org/en-US/docs/Web/API/HTMLImageElement/sizes
   */
  sizes?: string;

  /**
   * Image widths for srcset generation
   * - Default: [400, 800, 1200, 1600]
   * - Astro will generate optimized versions at these widths
   */
  widths?: number[];

  /**
   * Densities for srcset generation (alternative to widths)
   * - Example: [1, 2, 3] for 1x, 2x, 3x displays
   */
  densities?: number[];

  /**
   * Fetch priority hint for the browser
   * - 'high': Fetch immediately (for hero/LCP images)
   * - 'low': Defer fetching (for below-fold images)
   * - 'auto': Browser decides (default)
   */
  fetchpriority?: "high" | "low" | "auto";
}

const {
  src,
  alt,
  width,
  height,
  class: className,
  loading = "lazy",
  format = "webp",
  quality = 80,
  sizes,
  widths = [400, 800, 1200, 1600],
  fetchpriority = "auto",
} = Astro.props;

// Determine if this is an imported image or public path
const isImportedImage = typeof src !== "string";

// For public path images, width and height are required
if (!isImportedImage && (!width || !height)) {
  throw new Error(
    `OptimizedImage: width and height are required when using public path images. ` +
      `Got src="${src}", width=${width}, height=${height}`,
  );
}
---

<Image
  src={src}
  alt={alt}
  width={isImportedImage ? width : width!}
  height={isImportedImage ? height : height!}
  class={className}
  loading={loading}
  fetchpriority={fetchpriority}
  format={format}
  quality={quality}
  widths={widths}
  sizes={sizes}
/>
