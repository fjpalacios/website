---
import { t } from "@locales";
import { getLocalizedRoute } from "@utils/routes";

interface Props {
  currentPage: number;
  totalPages: number;
  basePath: string;
  lang?: "es" | "en";
}

const { currentPage, totalPages, basePath, lang = "es" } = Astro.props;

// Get localized "page" segment
const pageSegment = getLocalizedRoute("page", lang);

// Build URLs for prev/next pages
// Always use /{pageSegment}/N format for consistency, except for page 1 which is the base path
const prevUrl = currentPage === 2 ? basePath : `${basePath}/${pageSegment}/${currentPage - 1}`;
const nextUrl = `${basePath}/${pageSegment}/${currentPage + 1}`;
const firstUrl = basePath;
const lastUrl = `${basePath}/${pageSegment}/${totalPages}`;

const showPrev = currentPage > 1;
const showNext = currentPage < totalPages;
const showPaginator = totalPages > 1;

// Generate page number array with smart truncation
// Examples:
// - [1, 2, 3, 4, 5] for 5 pages
// - [1, "...", 5, 6, [7], 8, 9, "...", 20] for page 7 of 20
function getPageNumbers(): (number | string)[] {
  if (totalPages <= 7) {
    // Show all pages if 7 or less
    return Array.from({ length: totalPages }, (_, i) => i + 1);
  }

  const pages: (number | string)[] = [];

  // Always show first page
  pages.push(1);

  // Calculate range around current page
  const rangeStart = Math.max(2, currentPage - 1);
  const rangeEnd = Math.min(totalPages - 1, currentPage + 1);

  // Add ellipsis after first page if needed
  if (rangeStart > 2) {
    pages.push("...");
  }

  // Add pages around current page
  for (let i = rangeStart; i <= rangeEnd; i++) {
    pages.push(i);
  }

  // Add ellipsis before last page if needed
  if (rangeEnd < totalPages - 1) {
    pages.push("...");
  }

  // Always show last page
  if (totalPages > 1) {
    pages.push(totalPages);
  }

  return pages;
}

const pageNumbers = getPageNumbers();

// Helper to build page URL
function getPageUrl(page: number): string {
  return page === 1 ? basePath : `${basePath}/${pageSegment}/${page}`;
}
---

{
  showPaginator && (
    <nav class="paginator" aria-label="Pagination">
      <div class="paginator__controls">
        {/* First page button */}
        {currentPage > 2 && (
          <a href={firstUrl} class="paginator__button paginator__button--first" aria-label="First page">
            «
          </a>
        )}

        {/* Previous button */}
        {showPrev && (
          <a href={prevUrl} class="paginator__button paginator__button--prev" aria-label="Previous page">
            {t(lang, "paginator.prev")}
          </a>
        )}

        {/* Page numbers */}
        <div class="paginator__pages">
          {pageNumbers.map((page) => {
            if (page === "...") {
              return <span class="paginator__ellipsis">...</span>;
            }

            const pageNum = page as number;
            const isCurrentPage = pageNum === currentPage;
            const url = getPageUrl(pageNum);

            return isCurrentPage ? (
              <span class="paginator__page paginator__page--current" aria-current="page" aria-label={`Page ${pageNum}`}>
                {pageNum}
              </span>
            ) : (
              <a href={url} class="paginator__page" aria-label={`Page ${pageNum}`}>
                {pageNum}
              </a>
            );
          })}
        </div>

        {/* Next button */}
        {showNext && (
          <a href={nextUrl} class="paginator__button paginator__button--next" aria-label="Next page">
            {t(lang, "paginator.next")}
          </a>
        )}

        {/* Last page button */}
        {currentPage < totalPages - 1 && (
          <a href={lastUrl} class="paginator__button paginator__button--last" aria-label="Last page">
            »
          </a>
        )}
      </div>

      {/* Page info */}
      <div class="paginator__info">
        {`${t(lang, "paginator.page")} ${currentPage} ${t(lang, "paginator.of")} ${totalPages}`}
      </div>
    </nav>
  )
}
