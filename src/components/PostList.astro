---
import CourseBadge from "@components/CourseBadge.astro";
import OptimizedImage from "@components/OptimizedImage.astro";
import PostTitle from "@components/PostTitle.astro";
import SeriesBadge from "@components/SeriesBadge.astro";
import TutorialOrderBadge from "@components/TutorialOrderBadge.astro";
import { getPostCoverImage, getTutorialCoverImage, getBookCoverImage } from "@utils/imageImports";
import { IMAGE_DIMENSIONS, RESPONSIVE_SIZES } from "@utils/images";
import { buildBookUrl, buildTutorialUrl, buildPostUrl } from "@utils/routes";
import type { ImageMetadata } from "astro";

import type { PostSummary, TutorialSummary, BookSummary } from "@/utils/blog";

// Generic item type that works for posts, tutorials, and books
type ListItem = PostSummary | TutorialSummary | BookSummary;

interface Props {
  posts: ListItem[];
  lang: "es" | "en";
  showOrderBadges?: boolean; // Only show order badges in course context
}

const { posts, lang, showOrderBadges = false } = Astro.props;

// Get the correct URL path based on the item type and language
function getItemUrl(item: ListItem): string {
  const itemLang = item.language;

  switch (item.type) {
    case "book":
      return buildBookUrl(itemLang, item.slug);
    case "tutorial":
      return buildTutorialUrl(itemLang, item.slug);
    case "post":
    default:
      return buildPostUrl(itemLang, item.slug);
  }
}

// Get the correct cover image based on item type
function getItemCover(item: ListItem): ImageMetadata {
  switch (item.type) {
    case "book":
      return getBookCoverImage(item.cover, lang as "es" | "en");
    case "tutorial":
      return getTutorialCoverImage(item.cover);
    case "post":
    default:
      return getPostCoverImage(item.cover);
  }
}

// Get the correct image dimensions based on item type
function getItemDimensions(item: ListItem) {
  switch (item.type) {
    case "book":
      return IMAGE_DIMENSIONS.BOOK_COVER_MEDIUM; // 200x300 (2:3 vertical)
    case "tutorial":
    case "post":
    default:
      return IMAGE_DIMENSIONS.POST_COVER_MEDIUM; // 800x450 (16:9 horizontal)
  }
}
---

<main class="blog">
  <section class="blog__grid">
    {
      posts.map((post, index) => {
        const dimensions = getItemDimensions(post);
        // First item is the LCP candidate â€” load eagerly to avoid CLS and LCP delay
        const isFirstItem = index === 0;
        const imageLoading = isFirstItem ? "eager" : "lazy";
        const imageFetchPriority = isFirstItem ? "high" : "auto";
        const showOrderBadge =
          showOrderBadges &&
          ((post.type === "tutorial" && "order" in post && post.order !== undefined) ||
            (post.type === "book" && "series_order" in post && post.series_order !== undefined));

        // Get the order number based on content type
        const orderNumber =
          post.type === "tutorial" && "order" in post
            ? (post as TutorialSummary).order
            : post.type === "book" && "series_order" in post
              ? (post as BookSummary).series_order
              : undefined;

        // Check if tutorial has course info
        const showCourseBadge =
          post.type === "tutorial" &&
          "courseName" in post &&
          post.courseName !== undefined &&
          "course" in post &&
          post.course !== undefined;

        // Check if book has series info
        const showSeriesBadge =
          post.type === "book" &&
          "seriesName" in post &&
          post.seriesName !== undefined &&
          "series" in post &&
          post.series !== undefined;

        return (
          <a href={getItemUrl(post)}>
            <section class="blog__grid__post">
              <div class="blog__grid__post__image-wrapper">
                <OptimizedImage
                  src={getItemCover(post)}
                  alt={post.title}
                  width={dimensions.width}
                  height={dimensions.height}
                  sizes={RESPONSIVE_SIZES.HALF_WIDTH}
                  loading={imageLoading}
                  fetchpriority={imageFetchPriority}
                />
                {showOrderBadge && orderNumber !== undefined && <TutorialOrderBadge order={orderNumber} lang={lang} />}
                {showCourseBadge && (
                  <CourseBadge
                    courseName={(post as TutorialSummary).courseName!}
                    courseSlug={(post as TutorialSummary).course!}
                    lang={lang}
                  />
                )}
                {showSeriesBadge && (
                  <SeriesBadge
                    seriesName={(post as BookSummary).seriesName!}
                    seriesSlug={(post as BookSummary).series!}
                    lang={lang}
                  />
                )}
              </div>
              <PostTitle title={post.title} date={post.date} lang={lang} headingLevel="h2" />
              <div class="text-area">
                <p>{post.excerpt}</p>
              </div>
            </section>
          </a>
        );
      })
    }
  </section>
</main>
