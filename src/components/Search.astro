---
import { TIMINGS } from "../config/timings";

/**
 * Search component using Pagefind
 * Provides instant search with language filtering
 */
interface Props {
  lang: "es" | "en";
}

const { lang } = Astro.props;
---

<!-- Search Modal -->
<div class="search-modal" id="searchModal" aria-hidden="true">
  <div class="search-modal__backdrop"></div>
  <div class="search-modal__content" role="dialog" aria-modal="true" aria-labelledby="search-title">
    <div class="search-modal__header">
      <h2 id="search-title" class="sr-only">
        {lang === "es" ? "Buscar en el sitio" : "Search the site"}
      </h2>
      <button class="search-modal__close" type="button" aria-label="Close search">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="search-modal__container" id="search"></div>
  </div>
</div>

<style lang="scss">
  @use "../styles/components/search";
</style>

<!-- Inject config variables -->
<script
  is:inline
  set:html={`window.__SEARCH_CONFIG__ = ${JSON.stringify({ searchInputFocusDelay: TIMINGS.SEARCH_INPUT_FOCUS_MS })};`}
/>

<!-- Main search modal script -->
<script>
  // This script runs on every page load (including view transitions)
  (function () {
    const searchInputFocusDelay = window.__SEARCH_CONFIG__?.searchInputFocusDelay || 300;
    let pagefindUI = null;
    let pagefindCSSLoaded = false;

    // Ensure Pagefind CSS is loaded
    function ensurePagefindCSS() {
      if (pagefindCSSLoaded) return;

      const existingLink = document.querySelector('link[href*="pagefind-ui.css"]');
      if (existingLink) {
        pagefindCSSLoaded = true;
        return;
      }

      // If CSS link doesn't exist or failed to load, add it
      const link = document.createElement("link");
      link.rel = "stylesheet";
      link.href = "/pagefind/pagefind-ui.css";
      link.onload = () => {
        pagefindCSSLoaded = true;
      };
      document.head.appendChild(link);
    }

    function initializePagefind() {
      if (pagefindUI) return; // Already initialized

      const searchContainer = document.getElementById("search");
      if (!searchContainer || !window.PagefindUI) return;

      // Ensure CSS is loaded before initializing
      ensurePagefindCSS();

      // Get lang from body data attribute
      const lang = document.body.dataset.lang || "es";

      try {
        pagefindUI = new window.PagefindUI({
          element: "#search",
          showSubResults: false, // Disable sub-results to avoid duplicates
          showImages: false,
          excerptLength: 15,
          translations: {
            placeholder: lang === "es" ? "Buscar en el blog..." : "Search the blog...",
            clear_search: lang === "es" ? "Limpiar" : "Clear",
            load_more: lang === "es" ? "Cargar más resultados" : "Load more results",
            search_label: lang === "es" ? "Buscar en este sitio" : "Search this site",
            filters_label: lang === "es" ? "Filtros" : "Filters",
            zero_results:
              lang === "es" ? "No se encontraron resultados para [SEARCH_TERM]" : "No results for [SEARCH_TERM]",
            many_results: lang === "es" ? "[COUNT] resultados" : "[COUNT] results",
            one_result: lang === "es" ? "[COUNT] resultado" : "[COUNT] result",
            alt_search:
              lang === "es"
                ? "No se encontraron resultados para [SEARCH_TERM]. Mostrando resultados para [DIFFERENT_TERM]"
                : "No results for [SEARCH_TERM]. Showing results for [DIFFERENT_TERM] instead",
            search_suggestion:
              lang === "es"
                ? "No se encontraron resultados para [SEARCH_TERM]. Intenta una de las siguientes búsquedas:"
                : "No results for [SEARCH_TERM]. Try one of the following searches:",
            searching: lang === "es" ? "Buscando..." : "Searching...",
          },
        });
      } catch (error) {
        if (import.meta.env.DEV) {
          console.error("Error initializing Pagefind:", error);
        }
      }
    }

    // Focus trap implementation
    let focusTrapHandler = null;

    function setupFocusTrap(modal) {
      const focusableSelectors =
        'button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])';

      function getFocusableElements() {
        const elements = modal.querySelectorAll(focusableSelectors);
        return Array.from(elements).filter((el) => {
          // Ensure element is visible and not a hidden screen reader element
          const isVisible = el.offsetWidth > 0 && el.offsetHeight > 0;
          const isInsideModal = modal.contains(el);
          return isVisible && isInsideModal;
        });
      }

      function handleKeyDown(e) {
        // Only trap Tab key
        if (e.key !== "Tab") return;

        // Only trap if modal is open
        if (modal.getAttribute("aria-hidden") === "true") return;

        const focusableElements = getFocusableElements();
        if (focusableElements.length === 0) return;

        const firstElement = focusableElements[0];
        const lastElement = focusableElements[focusableElements.length - 1];
        const activeElement = document.activeElement;

        // Shift+Tab on first element: go to last
        if (e.shiftKey && activeElement === firstElement) {
          e.preventDefault();
          lastElement.focus();
          return;
        }

        // Tab on last element: go to first
        if (!e.shiftKey && activeElement === lastElement) {
          e.preventDefault();
          firstElement.focus();
          return;
        }
      }

      // Additional focus guard: if focus escapes modal, bring it back
      function handleFocusIn(e) {
        // Only trap if modal is open
        if (modal.getAttribute("aria-hidden") === "true") return;

        const target = e.target;

        // If focus is outside modal, redirect to first focusable element
        if (!modal.contains(target)) {
          e.preventDefault();
          e.stopPropagation();

          const focusableElements = getFocusableElements();
          if (focusableElements.length > 0) {
            focusableElements[0].focus();
          }
        }
      }

      focusTrapHandler = { keydown: handleKeyDown, focusin: handleFocusIn };

      // Add both listeners
      document.addEventListener("keydown", focusTrapHandler.keydown, true);
      document.addEventListener("focusin", focusTrapHandler.focusin, true);
    }

    function removeFocusTrap(_modal) {
      if (focusTrapHandler) {
        document.removeEventListener("keydown", focusTrapHandler.keydown, true);
        document.removeEventListener("focusin", focusTrapHandler.focusin, true);
        focusTrapHandler = null;
      }
    }

    // Open modal
    function openSearch() {
      const modal = document.getElementById("searchModal");
      if (modal) {
        modal.setAttribute("aria-hidden", "false");
        document.body.style.overflow = "hidden";

        // Setup focus trap IMMEDIATELY (before Pagefind initializes)
        setupFocusTrap(modal);

        // Initialize Pagefind if not already done
        initializePagefind();

        // Focus search input after a short delay (from TIMINGS.SEARCH_INPUT_FOCUS_MS)
        setTimeout(function () {
          const input = modal.querySelector(".pagefind-ui__search-input");
          if (input) {
            input.focus();
          } else {
            // If Pagefind hasn't initialized yet, focus close button
            const closeButton = modal.querySelector(".search-modal__close");
            if (closeButton) {
              closeButton.focus();
            }
          }
        }, searchInputFocusDelay);
      }
    }

    // Close modal
    function closeSearch() {
      const modal = document.getElementById("searchModal");
      if (modal) {
        modal.setAttribute("aria-hidden", "true");
        document.body.style.overflow = "";

        // Remove focus trap
        removeFocusTrap(modal);
      }
    }

    // Setup event listeners
    function setupSearchListeners() {
      // Keyboard shortcut (Cmd+K / Ctrl+K)
      document.addEventListener("keydown", function (e) {
        if ((e.metaKey || e.ctrlKey) && e.key === "k") {
          e.preventDefault();
          openSearch();
        }

        // ESC to close
        if (e.key === "Escape") {
          closeSearch();
        }
      });

      // Button click (from menu)
      const searchButton = document.getElementById("search-toggle");
      if (searchButton) {
        searchButton.addEventListener("click", openSearch);
      }

      // Close button
      const closeButton = document.querySelector(".search-modal__close");
      if (closeButton) {
        closeButton.addEventListener("click", closeSearch);
      }

      // Click backdrop to close
      const backdrop = document.querySelector(".search-modal__backdrop");
      if (backdrop) {
        backdrop.addEventListener("click", closeSearch);
      }
    }

    // Run on initial page load and after view transitions
    if (document.addEventListener) {
      document.addEventListener("astro:page-load", setupSearchListeners);
    }

    // If astro:page-load already fired or not available, run immediately
    if (document.readyState === "complete" || document.readyState === "interactive") {
      setTimeout(setupSearchListeners, 1);
    }
  })();
</script>
