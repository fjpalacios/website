---
/**
 * Search component using Pagefind
 * Provides instant search with language filtering
 */
interface Props {
  lang: "es" | "en";
}

const { lang } = Astro.props;
---

<!-- Search Modal -->
<div class="search-modal" id="searchModal" aria-hidden="true">
  <div class="search-modal__backdrop"></div>
  <div class="search-modal__content" role="dialog" aria-modal="true" aria-labelledby="search-title">
    <div class="search-modal__header">
      <h2 id="search-title" class="sr-only">
        {lang === "es" ? "Buscar en el sitio" : "Search the site"}
      </h2>
      <button class="search-modal__close" type="button" aria-label="Close search">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="search-modal__container" id="search"></div>
  </div>
</div>

<style lang="scss">
  @use "../styles/components/search";
</style>

<script is:inline>
  // This script runs on every page load (including view transitions)
  (function () {
    let pagefindUI = null;

    function initializePagefind() {
      if (pagefindUI) return; // Already initialized

      const searchContainer = document.getElementById("search");
      if (!searchContainer || !window.PagefindUI) return;

      // Get lang from body data attribute
      const lang = document.body.dataset.lang || "es";

      try {
        pagefindUI = new window.PagefindUI({
          element: "#search",
          showSubResults: true,
          showImages: false,
          excerptLength: 15,
          translations: {
            placeholder: lang === "es" ? "Buscar en el blog..." : "Search the blog...",
            clear_search: lang === "es" ? "Limpiar" : "Clear",
            load_more: lang === "es" ? "Cargar más resultados" : "Load more results",
            search_label: lang === "es" ? "Buscar en este sitio" : "Search this site",
            filters_label: lang === "es" ? "Filtros" : "Filters",
            zero_results:
              lang === "es" ? "No se encontraron resultados para [SEARCH_TERM]" : "No results for [SEARCH_TERM]",
            many_results: lang === "es" ? "[COUNT] resultados" : "[COUNT] results",
            one_result: lang === "es" ? "[COUNT] resultado" : "[COUNT] result",
            alt_search:
              lang === "es"
                ? "No se encontraron resultados para [SEARCH_TERM]. Mostrando resultados para [DIFFERENT_TERM]"
                : "No results for [SEARCH_TERM]. Showing results for [DIFFERENT_TERM] instead",
            search_suggestion:
              lang === "es"
                ? "No se encontraron resultados para [SEARCH_TERM]. Intenta una de las siguientes búsquedas:"
                : "No results for [SEARCH_TERM]. Try one of the following searches:",
            searching: lang === "es" ? "Buscando..." : "Searching...",
          },
        });
      } catch (error) {
        console.error("Error initializing Pagefind:", error);
      }
    }

    // Open modal
    function openSearch() {
      const modal = document.getElementById("searchModal");
      if (modal) {
        modal.setAttribute("aria-hidden", "false");
        document.body.style.overflow = "hidden";

        // Initialize Pagefind if not already done
        initializePagefind();

        // Focus search input after a short delay
        setTimeout(function () {
          const input = modal.querySelector(".pagefind-ui__search-input");
          if (input) {
            input.focus();
          }
        }, 300);
      }
    }

    // Close modal
    function closeSearch() {
      const modal = document.getElementById("searchModal");
      if (modal) {
        modal.setAttribute("aria-hidden", "true");
        document.body.style.overflow = "";
      }
    }

    // Setup event listeners
    function setupSearchListeners() {
      // Keyboard shortcut (Cmd+K / Ctrl+K)
      document.addEventListener("keydown", function (e) {
        if ((e.metaKey || e.ctrlKey) && e.key === "k") {
          e.preventDefault();
          openSearch();
        }

        // ESC to close
        if (e.key === "Escape") {
          closeSearch();
        }
      });

      // Button click (from menu)
      const searchButton = document.getElementById("search-toggle");
      if (searchButton) {
        searchButton.addEventListener("click", openSearch);
      }

      // Close button
      const closeButton = document.querySelector(".search-modal__close");
      if (closeButton) {
        closeButton.addEventListener("click", closeSearch);
      }

      // Click backdrop to close
      const backdrop = document.querySelector(".search-modal__backdrop");
      if (backdrop) {
        backdrop.addEventListener("click", closeSearch);
      }
    }

    // Run on initial page load and after view transitions
    if (document.addEventListener) {
      document.addEventListener("astro:page-load", setupSearchListeners);
    }

    // If astro:page-load already fired or not available, run immediately
    if (document.readyState === "complete" || document.readyState === "interactive") {
      setTimeout(setupSearchListeners, 1);
    }
  })();
</script>
