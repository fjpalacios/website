---
/**
 * BookLink Component
 * Creates internal links to book reviews within MDX content
 *
 * Usage in MDX:
 * <BookLink title="Apocalipsis, de Stephen King" />
 * <BookLink title="Apocalipsis, de Stephen King" full={true} />
 * <BookLink title="The Stand, by Stephen King" lang="es" />
 *
 * Props:
 * - title: Book title (can be partial, e.g., "Apocalipsis" or "Apocalipsis, de Stephen King")
 * - full: Display full title with author (default: false)
 * - lang: Language to search in ("es" | "en", default: auto-detected from URL)
 */

import { findBook, generateDisplayTitle, generateBookUrl, detectLanguageFromUrl } from "@utils/bookLinkHelpers";
import { getCollection } from "astro:content";

interface Props {
  title: string;
  full?: boolean;
  lang?: "es" | "en";
}

// Detect current language from URL (default to "es" if not found)
const detectedLang = detectLanguageFromUrl(Astro.url.pathname);

const { title, full = false, lang = detectedLang } = Astro.props;

// Query all books and find the matching one, excluding drafts
const allBooksRaw = await getCollection("books");
// eslint-disable-next-line @typescript-eslint/no-explicit-any -- Dynamic draft field access
const allBooks = allBooksRaw.filter((book) => !(book.data as any).draft);
const book = findBook(allBooks, title, lang);

// Generate display text and URL
const displayTitle = generateDisplayTitle(title, full, book);
const bookUrl = generateBookUrl(book, lang);
---

{bookUrl ? <a href={bookUrl} set:html={displayTitle} /> : <Fragment set:html={displayTitle} />}
