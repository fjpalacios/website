---
import { SKILL_COLORS } from "@constants/colors";
import { getCollection } from "astro:content";

import SkillBar from "./SkillBar.astro";

interface Props {
  year: string;
}

const { year } = Astro.props;

// Reading challenge goals by year
const challenges: Record<string, number> = {
  "2012": 30,
  "2013": 30,
  "2014": 30,
  "2015": 30,
  "2016": 30,
  "2017": 30,
  "2021": 6,
};

// Get all books from the collection, excluding drafts
const allBooksRaw = await getCollection("books");
// eslint-disable-next-line @typescript-eslint/no-explicit-any -- Dynamic draft field access
const allBooks = allBooksRaw.filter((book) => !(book.data as any).draft);

// Filter books by year
const booksInYear = allBooks.filter((book) => {
  const bookYear = new Date(book.data.date).getFullYear().toString();
  return bookYear === year;
});

const booksCount = booksInYear.length;
const challengeGoal = challenges[year] || 30; // Default to 30 if year not in challenges

// Calculate percentage
const percentage = Math.round((booksCount / challengeGoal) * 100);
const clampedPercentage = Math.min(100, percentage);

// Color based on completion
const color = percentage >= 100 ? SKILL_COLORS.SUCCESS : SKILL_COLORS.ERROR;
---

<SkillBar text={year} width={clampedPercentage} color={color} />
