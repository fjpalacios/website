---
import Header from "@components/Header.astro";
import Menu from "@components/Menu.astro";
import Search from "@components/Search.astro";
import SEO from "@components/SEO.astro";
import { t } from "@locales";
import type { ContactItem } from "@types/content";
import { ViewTransitions } from "astro:transitions";

interface Props {
  lang: string;
  title?: string;
  description?: string;
  contact: ContactItem[];
  translationSlug?: string; // Slug of the translated version (from i18n field)
  hasTargetContent?: boolean; // Whether target language has content (for index pages)
  shortTitle?: boolean; // Use short title without site name suffix (for taxonomy pages)
  // SEO-specific props
  image?: string;
  type?: "website" | "article" | "book";
  schema?: Record<string, unknown>;
}

const {
  lang,
  title,
  description,
  contact,
  translationSlug,
  hasTargetContent,
  shortTitle = false,
  image,
  type = "website",
  schema,
} = Astro.props;
const currentPath = Astro.url.pathname;

// Build full title: "Page Title - Name" or just "Name" for home
// For taxonomy pages with shortTitle=true, use only the title without site name
const fullName = t(lang, "title");
const metaTitle = shortTitle ? title || fullName : title ? `${title} - ${fullName}` : fullName;
const metaDescription = description || t(lang, "metaData.description");
const metaImage = image || t(lang, "metaData.image");
// Build full URL with current path
const baseUrl = t(lang, "metaData.url");
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={metaDescription} />

    <!-- SEO Component: Open Graph, Twitter Cards, Canonical, Hreflang, JSON-LD -->
    <SEO
      title={metaTitle}
      description={metaDescription}
      image={metaImage}
      type={type}
      lang={lang}
      translationSlug={translationSlug}
      schema={schema}
    />

    <link rel="icon" type="image/x-icon" href="/favicon.ico" />

    <!-- RSS Feeds - Autodiscovery -->
    <link
      rel="alternate"
      type="application/rss+xml"
      title={`${t(lang, "title")} - ${t(lang, "feeds.general")}`}
      href={lang === "es" ? "/es/rss.xml" : "/en/rss.xml"}
    />
    <link
      rel="alternate"
      type="application/rss+xml"
      title={`${t(lang, "title")} - ${t(lang, "feeds.books")}`}
      href={lang === "es" ? "/es/libros/rss.xml" : "/en/books/rss.xml"}
    />
    <link
      rel="alternate"
      type="application/rss+xml"
      title={`${t(lang, "title")} - ${t(lang, "feeds.tutorials")}`}
      href={lang === "es" ? "/es/tutoriales/rss.xml" : "/en/tutorials/rss.xml"}
    />

    <ViewTransitions />
    <style is:global lang="scss">
      @use "../styles/main";
    </style>
    <title>{metaTitle}</title>

    <!-- Pagefind CSS and JS -->
    <link rel="stylesheet" href="/pagefind/pagefind-ui.css" />
    <script is:inline src="/pagefind/pagefind-ui.js"></script>

    <script is:inline>
      // Prevent FOUC (Flash of Unstyled Content) by applying theme before render
      // This must execute synchronously before body rendering
      (function () {
        const theme = localStorage.getItem("theme") || "dark";
        // Apply to html immediately (already available)
        document.documentElement.classList.add(theme);
        // Also set a data attribute for CSS to use
        document.documentElement.setAttribute("data-theme", theme);
      })();
    </script>
    <!-- Person schema for site owner (site-wide, not page-specific) -->
    <script
      type="application/ld+json"
      set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "Person",
        name: t(lang, "title"),
        jobTitle: t(lang, "subtitle"),
        url: baseUrl,
        sameAs: ["https://www.linkedin.com/in/fjpalacios/", "https://github.com/fjpalacios"],
        address: {
          "@type": "PostalAddress",
          addressLocality: "Valencia",
          addressCountry: "ES",
        },
      })}
    />
  </head>
  <body data-lang={lang}>
    <script is:inline>
      // Apply theme to body as soon as it's available (prevents FOUC)
      (function () {
        const theme = localStorage.getItem("theme") || "dark";
        document.body.classList.add(theme);
      })();
    </script>
    <!-- Screen reader announcements for code copy actions -->
    <div
      id="code-copy-status"
      role="status"
      aria-live="polite"
      aria-atomic="true"
      style="position: absolute; left: -10000px; width: 1px; height: 1px; overflow: hidden;"
    >
    </div>
    <div class="layout-wrapper">
      <div class="container">
        <Menu
          lang={lang}
          currentPath={currentPath}
          translationSlug={translationSlug}
          hasTargetContent={hasTargetContent}
          data-pagefind-ignore
        />
        <Header lang={lang} contact={contact} />
        <!-- Named slot for JSON-LD schemas (outside pagefind-body to avoid indexing) -->
        <slot name="schema" />
        <div class="content" data-pagefind-body>
          <slot />
        </div>
      </div>
    </div>
    <!-- Search Modal (global, accessible from menu) -->
    <Search lang={lang} />
    <script is:inline define:vars={{ copyText: t(lang, "codeBlock.copy"), copiedText: t(lang, "codeBlock.copied") }}>
      // Store translations in global scope
      window.__CODE_BLOCK_I18N__ = { copyText, copiedText };
    </script>
    <script is:inline>
      // Add copy buttons and language labels to Prism code blocks
      (function () {
        function setupCodeBlocks() {
          const codeBlocks = document.querySelectorAll('pre[class*="language-"]');

          // Get translations from global scope
          const i18n = window.__CODE_BLOCK_I18N__ || { copyText: "Copy code", copiedText: "Copied" };

          codeBlocks.forEach((pre) => {
            // Skip if already setup
            if (pre.querySelector(".code-toolbar")) {
              return;
            }

            try {
              // Extract language from class
              const languageClass = Array.from(pre.classList).find((cls) => cls.startsWith("language-"));
              const language = languageClass ? languageClass.replace("language-", "") : "text";

              // Create language label
              const langLabel = document.createElement("span");
              langLabel.className = "code-language-label";
              langLabel.textContent = language;

              // Create copy button
              const button = document.createElement("button");
              button.className = "code-copy-button";
              button.setAttribute("aria-label", i18n.copyText);
              button.setAttribute("type", "button");
              button.textContent = "ðŸ“‹";

              button.addEventListener("click", async () => {
                const code = pre.querySelector("code");
                if (!code) return;

                try {
                  await navigator.clipboard.writeText(code.textContent || "");
                  button.textContent = "âœ“";
                  button.classList.add("copied");

                  // Announce to screen readers
                  const statusEl = document.getElementById("code-copy-status");
                  if (statusEl) {
                    statusEl.textContent = i18n.copiedText;
                  }

                  setTimeout(() => {
                    button.textContent = "ðŸ“‹";
                    button.classList.remove("copied");
                    if (statusEl) {
                      statusEl.textContent = "";
                    }
                  }, TIMINGS.CODE_COPY_FEEDBACK_MS);
                } catch (err) {
                  console.error("Failed to copy code:", err);
                }
              });

              // Create toolbar container
              const toolbar = document.createElement("div");
              toolbar.className = "code-toolbar";

              // Add elements to toolbar
              toolbar.appendChild(langLabel);
              toolbar.appendChild(button);

              // Add toolbar to pre element
              pre.style.position = "relative";
              pre.appendChild(toolbar);
            } catch (error) {
              console.error("Error setting up code block:", error);
            }
          });
        }

        // Run setup
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", setupCodeBlocks);
        } else {
          setupCodeBlocks();
        }

        // Run on Astro page transitions
        document.addEventListener("astro:page-load", setupCodeBlocks);
      })();
    </script>
  </body>
</html>
