---
/**
 * Posts Detail Page Template
 * Displays a single post with metadata
 *
 * Used by: /en/posts/[slug]/ and /es/publicaciones/[slug]/
 * Features: Categories, cover image, schema.org BlogPosting
 *
 * NOTE: This template is ONLY for the "posts" collection.
 * Books and tutorials have their own detail pages.
 */

import Icon from "@components/Icon.astro";
import OptimizedImage from "@components/OptimizedImage.astro";
import PostTitle from "@components/PostTitle.astro";
import Share from "@components/Share.astro";
import Layout from "@layouts/Layout.astro";
import { t } from "@locales";
import { getPostCoverImage } from "@utils/imageImports";
import { IMAGE_DIMENSIONS, RESPONSIVE_SIZES } from "@utils/images";
import { buildCategoryUrl } from "@utils/routes";
import { render, type CollectionEntry } from "astro:content";

import type { ContactItem } from "@/types/content";
import { findCategoriesBySlug } from "@/utils/blog";
import { getCollectionByLanguage } from "@/utils/content/getCollectionByLanguage";

interface Props {
  lang: "en" | "es";
  postEntry: CollectionEntry<"posts">;
  contact: ContactItem[];
}

const { lang, postEntry, contact } = Astro.props;
const post = postEntry.data;
const { Content } = await render(postEntry);

// Get categories from taxonomy collection (filtered by language)
const allCategories = await getCollectionByLanguage("categories", lang);
const categories = findCategoriesBySlug(allCategories, post.categories);

// Cover image with fallback (returns ImageMetadata for optimization)
const coverImage = getPostCoverImage(post.cover);
// Keep original path for meta tags (Layout expects string)
const coverImagePath = post.cover || "/images/defaults/post-default.jpg";

// Share component data
const baseUrl = t(lang, "metaData.url");
const currentUrl = new URL(Astro.url.pathname, baseUrl).href;
const twitterUsername = t(lang, "metaData.twitterUsername");

// Build JSON-LD schema for article
const categoryLabel = lang === "en" ? "Category" : "Categor√≠a";
const articleSchema: Record<string, unknown> = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: post.title,
  description: post.excerpt,
  image: coverImagePath,
  datePublished: post.date.toISOString(),
  author: {
    "@type": "Person",
    name: t(lang, "title"),
  },
  publisher: {
    "@type": "Person",
    name: t(lang, "title"),
  },
  inLanguage: lang,
};

// Add modified date if available
if (post.updated) {
  articleSchema.dateModified = post.updated.toISOString();
}
---

<Layout
  lang={lang}
  title={post.title}
  description={post.excerpt}
  contact={contact}
  translationSlug={post.i18n}
  image={coverImagePath}
  type="article"
  schema={articleSchema}
>
  <main class="post">
    <section class="post__content">
      <div class="cover-image-wrapper">
        <OptimizedImage
          src={coverImage}
          alt={post.title}
          width={IMAGE_DIMENSIONS.POST_COVER_MEDIUM.width}
          height={IMAGE_DIMENSIONS.POST_COVER_MEDIUM.height}
          sizes={RESPONSIVE_SIZES.FULL_WIDTH}
          loading="eager"
        />
      </div>
      <!-- Pagefind title meta -->
      <span data-pagefind-meta="title" class="pagefind-meta">{post.title}</span>
      <PostTitle title={post.title} date={post.date} lang={lang} />
      <div class="text-area">
        <Content />
      </div>
    </section>

    <section class="post__info">
      <Icon name="folder" size="md" class="post__info__icon" />
      <ul class="post__info__text">
        {
          categories.map((category) => (
            <li>
              <a
                href={buildCategoryUrl(lang, category.data.category_slug)}
                class="post__info__text__item"
                title={categoryLabel}
              >
                {category.data.name}
              </a>
            </li>
          ))
        }
      </ul>
    </section>
  </main>
  <Share title={post.title} url={currentUrl} lang={lang} twitterUsername={twitterUsername} />
</Layout>

<style lang="scss">
  @use "@/styles/components/post.scss";
</style>
