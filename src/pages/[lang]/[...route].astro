---
/**
 * Unified Dynamic Routing - All Content Types & Taxonomies (Phase 4 Refactored)
 *
 * Refactored version using route generators to reduce complexity from 779 to ~250 lines.
 *
 * Handles all main content type pages:
 * - Books: /en/books, /es/libros (list, pagination, detail)
 * - Tutorials: /en/tutorials, /es/tutoriales (list, pagination, detail)
 * - Posts: /en/posts, /es/publicaciones (list, pagination, detail - mixed content)
 * - Taxonomies: Authors, Publishers, Genres, Categories, Series, Challenges, Courses
 * - Static: About, Feeds
 *
 * This replaces 52 duplicate page files with 1 unified router + 25 templates.
 *
 * Phase 4 Optimization: Extracted route generation logic to utilities
 * @see src/utils/routeGenerators/
 */

import type { GetStaticPaths } from "astro";

// Contact data
import contactEn from "@/content/static/contact/en.json";
import contactEs from "@/content/static/contact/es.json";

// Page templates - Books

// Page templates - Tutorials

// Page templates - Posts

// Page templates - Taxonomies
import AuthorsDetailPage from "@/pages-templates/authors/AuthorsDetailPage.astro";
import AuthorsListPage from "@/pages-templates/authors/AuthorsListPage.astro";
import BooksDetailPage from "@/pages-templates/books/BooksDetailPage.astro";
import BooksListPage from "@/pages-templates/books/BooksListPage.astro";
import BooksPaginationPage from "@/pages-templates/books/BooksPaginationPage.astro";
import CategoriesDetailPage from "@/pages-templates/categories/CategoriesDetailPage.astro";
import CategoriesListPage from "@/pages-templates/categories/CategoriesListPage.astro";
import ChallengesDetailPage from "@/pages-templates/challenges/ChallengesDetailPage.astro";
import ChallengesListPage from "@/pages-templates/challenges/ChallengesListPage.astro";
import CoursesDetailPage from "@/pages-templates/courses/CoursesDetailPage.astro";
import CoursesListPage from "@/pages-templates/courses/CoursesListPage.astro";
import GenresDetailPage from "@/pages-templates/genres/GenresDetailPage.astro";
import GenresListPage from "@/pages-templates/genres/GenresListPage.astro";
import PostsDetailPage from "@/pages-templates/posts/PostsDetailPage.astro";
import PostsListPage from "@/pages-templates/posts/PostsListPage.astro";
import PostsPaginationPage from "@/pages-templates/posts/PostsPaginationPage.astro";
import PublishersDetailPage from "@/pages-templates/publishers/PublishersDetailPage.astro";
import PublishersListPage from "@/pages-templates/publishers/PublishersListPage.astro";
import SeriesDetailPage from "@/pages-templates/series/SeriesDetailPage.astro";
import SeriesListPage from "@/pages-templates/series/SeriesListPage.astro";

// Page templates - Static
import AboutPage from "@/pages-templates/static/AboutPage.astro";
import FeedsPage from "@/pages-templates/static/FeedsPage.astro";
import TutorialsDetailPage from "@/pages-templates/tutorials/TutorialsDetailPage.astro";
import TutorialsListPage from "@/pages-templates/tutorials/TutorialsListPage.astro";
import TutorialsPaginationPage from "@/pages-templates/tutorials/TutorialsPaginationPage.astro";

// Route generators (Phase 4)

// Utilities
import { paginateItems, getPageCount } from "@/utils/blog";
import { getAllBooksForLanguage, BOOKS_PER_PAGE, generateBookDetailPaths } from "@/utils/booksPages";
import { getAllContentForLanguage, POSTS_PER_PAGE, generatePostDetailPaths } from "@/utils/postsPages";
import {
  generateContentTypeWithPaginationRoutes,
  generateTaxonomyRoutes,
  generateStaticPageRoute,
} from "@/utils/routeGenerators";
import { getLanguages } from "@/utils/routes";
import { generateItemListSchema } from "@/utils/schemas/itemList";
import { TAXONOMY_CONFIGS } from "@/utils/taxonomyPages";
import { getAllTutorialsForLanguage, TUTORIALS_PER_PAGE, generateTutorialDetailPaths } from "@/utils/tutorialsPages";

export const getStaticPaths: GetStaticPaths = async () => {
  const languages = getLanguages();
  const paths: { params: { lang: string; route: string }; props: Record<string, unknown> }[] = [];

  for (const lang of languages) {
    const contact = lang === "en" ? contactEn : contactEs;
    const targetLang = lang === "en" ? "es" : "en";

    // =================================================================
    // BOOKS - Using route generator
    // =================================================================
    paths.push(
      ...(await generateContentTypeWithPaginationRoutes({
        lang,
        targetLang,
        routeSegment: lang === "en" ? "books" : "libros",
        pageSegment: lang === "en" ? "page" : "pagina",
        contentType: "books",
        getAllItems: getAllBooksForLanguage,
        itemsPerPage: BOOKS_PER_PAGE,
        generateDetailPaths: generateBookDetailPaths,
        contact,
        schemaType: "Book",
        extractItemData: (book) => ({
          name: book.title,
          slug: book.slug,
          excerpt: book.excerpt,
        }),
      })),
    );

    // =================================================================
    // TUTORIALS - Using route generator
    // =================================================================
    paths.push(
      ...(await generateContentTypeWithPaginationRoutes({
        lang,
        targetLang,
        routeSegment: lang === "en" ? "tutorials" : "tutoriales",
        pageSegment: lang === "en" ? "page" : "pagina",
        contentType: "tutorials",
        getAllItems: getAllTutorialsForLanguage,
        itemsPerPage: TUTORIALS_PER_PAGE,
        generateDetailPaths: generateTutorialDetailPaths,
        contact,
        schemaType: "TechArticle",
        extractItemData: (tutorial) => ({
          name: tutorial.title,
          slug: tutorial.slug,
          excerpt: tutorial.excerpt,
        }),
      })),
    );

    // =================================================================
    // POSTS - Special case (mixed content: posts + tutorials + books)
    // Cannot use generic generator due to complex schema mapping
    // =================================================================
    {
      const routeSegment = lang === "en" ? "posts" : "publicaciones";
      const pageSegment = lang === "en" ? "page" : "pagina";

      // Get all content (posts, tutorials, books combined)
      const sortedContent = await getAllContentForLanguage(lang);
      const targetContent = await getAllContentForLanguage(targetLang);
      const hasTargetContent = targetContent.length > 0;
      const totalPages = getPageCount(sortedContent.length, POSTS_PER_PAGE);

      // 1. LIST PAGE
      const posts = paginateItems(sortedContent, 1, POSTS_PER_PAGE);

      // Generate ItemList schema for mixed content
      const itemListSchema = generateItemListSchema(
        posts.map((post) => {
          // Map content type to Schema.org type
          const schemaType = post.type === "book" ? "Book" : post.type === "tutorial" ? "TechArticle" : "BlogPosting";

          // Map to correct route segment
          const routeKey = post.type === "book" ? "books" : post.type === "tutorial" ? "tutorials" : "posts";

          return {
            name: post.title,
            url: `/${lang}/${
              lang === "en"
                ? routeKey
                : routeKey === "books"
                  ? "libros"
                  : routeKey === "tutorials"
                    ? "tutoriales"
                    : "publicaciones"
            }/${post.slug}/`,
            type: schemaType,
            description: post.excerpt,
          };
        }),
        "https://fjp.es",
      );

      paths.push({
        params: { lang, route: routeSegment },
        props: {
          contentType: "posts",
          pageType: "list",
          lang,
          posts,
          currentPage: 1,
          totalPages,
          itemListSchema,
          contact,
          hasTargetContent,
        },
      });

      // 2. PAGINATION PAGES
      for (let page = 2; page <= totalPages; page++) {
        const paginatedPosts = paginateItems(sortedContent, page, POSTS_PER_PAGE);

        paths.push({
          params: { lang, route: `${routeSegment}/${pageSegment}/${page}` },
          props: {
            contentType: "posts",
            pageType: "pagination",
            lang,
            posts: paginatedPosts,
            currentPage: page,
            totalPages,
            contact,
            hasTargetContent,
          },
        });
      }

      // 3. DETAIL PAGES (only for "posts" collection, not books/tutorials)
      const postDetailPaths = await generatePostDetailPaths(lang, contact);
      for (const { slug, props } of postDetailPaths) {
        paths.push({
          params: { lang, route: `${routeSegment}/${slug}` },
          props: {
            contentType: "posts",
            pageType: "detail",
            ...props,
            hasTargetContent,
          },
        });
      }
    }

    // =================================================================
    // TAXONOMIES - Using route generator
    // =================================================================

    // AUTHORS
    paths.push(
      ...(await generateTaxonomyRoutes({
        taxonomyConfig: TAXONOMY_CONFIGS.authors,
        lang,
        targetLang,
        routeSegment: lang === "en" ? "authors" : "autores",
        contentType: "authors",
        contact,
        itemsPropsKey: "authorsWithCounts",
      })),
    );

    // PUBLISHERS
    paths.push(
      ...(await generateTaxonomyRoutes({
        taxonomyConfig: TAXONOMY_CONFIGS.publishers,
        lang,
        targetLang,
        routeSegment: lang === "en" ? "publishers" : "editoriales",
        contentType: "publishers",
        contact,
        itemsPropsKey: "publishersWithCounts",
      })),
    );

    // GENRES
    paths.push(
      ...(await generateTaxonomyRoutes({
        taxonomyConfig: TAXONOMY_CONFIGS.genres,
        lang,
        targetLang,
        routeSegment: lang === "en" ? "genres" : "generos",
        contentType: "genres",
        contact,
        itemsPropsKey: "genresWithCounts",
      })),
    );

    // CATEGORIES
    paths.push(
      ...(await generateTaxonomyRoutes({
        taxonomyConfig: TAXONOMY_CONFIGS.categories,
        lang,
        targetLang,
        routeSegment: lang === "en" ? "categories" : "categorias",
        contentType: "categories",
        contact,
        itemsPropsKey: "categoriesWithCounts",
      })),
    );

    // SERIES
    paths.push(
      ...(await generateTaxonomyRoutes({
        taxonomyConfig: TAXONOMY_CONFIGS.series,
        lang,
        targetLang,
        routeSegment: lang === "en" ? "series" : "series",
        contentType: "series",
        contact,
        itemsPropsKey: "seriesWithCounts",
      })),
    );

    // CHALLENGES
    paths.push(
      ...(await generateTaxonomyRoutes({
        taxonomyConfig: TAXONOMY_CONFIGS.challenges,
        lang,
        targetLang,
        routeSegment: lang === "en" ? "challenges" : "retos",
        contentType: "challenges",
        contact,
        itemsPropsKey: "challengesWithCounts",
      })),
    );

    // COURSES
    paths.push(
      ...(await generateTaxonomyRoutes({
        taxonomyConfig: TAXONOMY_CONFIGS.courses,
        lang,
        targetLang,
        routeSegment: lang === "en" ? "courses" : "cursos",
        contentType: "courses",
        contact,
        itemsPropsKey: "coursesWithCounts",
      })),
    );

    // =================================================================
    // STATIC PAGES - Using route generator
    // =================================================================

    // ABOUT PAGE
    const aboutContent = await import(`@content/${lang}/about.ts`).then((mod) => mod.about);
    paths.push(
      ...generateStaticPageRoute({
        lang,
        routeSegment: lang === "en" ? "about" : "acerca-de",
        contentType: "about",
        contact,
        content: aboutContent,
      }),
    );

    // FEEDS PAGE
    paths.push(
      ...generateStaticPageRoute({
        lang,
        routeSegment: "feeds",
        contentType: "feeds",
        contact,
      }),
    );
  }

  console.log(`[Unified Routing] Generated ${paths.length} paths (all content types + taxonomies + static pages)`);
  return paths;
};

const { pageType, contentType } = Astro.props;
---

{/* Books */}
{contentType === "books" && pageType === "list" && <BooksListPage {...Astro.props} />}
{contentType === "books" && pageType === "pagination" && <BooksPaginationPage {...Astro.props} />}
{contentType === "books" && pageType === "detail" && <BooksDetailPage {...Astro.props} />}

{/* Tutorials */}
{contentType === "tutorials" && pageType === "list" && <TutorialsListPage {...Astro.props} />}
{contentType === "tutorials" && pageType === "pagination" && <TutorialsPaginationPage {...Astro.props} />}
{contentType === "tutorials" && pageType === "detail" && <TutorialsDetailPage {...Astro.props} />}

{/* Posts */}
{contentType === "posts" && pageType === "list" && <PostsListPage {...Astro.props} />}
{contentType === "posts" && pageType === "pagination" && <PostsPaginationPage {...Astro.props} />}
{contentType === "posts" && pageType === "detail" && <PostsDetailPage {...Astro.props} />}

{/* Authors */}
{contentType === "authors" && pageType === "list" && <AuthorsListPage {...Astro.props} />}
{contentType === "authors" && pageType === "detail" && <AuthorsDetailPage {...Astro.props} />}

{/* Publishers */}
{contentType === "publishers" && pageType === "list" && <PublishersListPage {...Astro.props} />}
{contentType === "publishers" && pageType === "detail" && <PublishersDetailPage {...Astro.props} />}

{/* Genres */}
{contentType === "genres" && pageType === "list" && <GenresListPage {...Astro.props} />}
{contentType === "genres" && pageType === "detail" && <GenresDetailPage {...Astro.props} />}

{/* Categories */}
{contentType === "categories" && pageType === "list" && <CategoriesListPage {...Astro.props} />}
{contentType === "categories" && pageType === "detail" && <CategoriesDetailPage {...Astro.props} />}

{/* Series */}
{contentType === "series" && pageType === "list" && <SeriesListPage {...Astro.props} />}
{contentType === "series" && pageType === "detail" && <SeriesDetailPage {...Astro.props} />}

{/* Challenges */}
{contentType === "challenges" && pageType === "list" && <ChallengesListPage {...Astro.props} />}
{contentType === "challenges" && pageType === "detail" && <ChallengesDetailPage {...Astro.props} />}

{/* Courses */}
{contentType === "courses" && pageType === "list" && <CoursesListPage {...Astro.props} />}
{contentType === "courses" && pageType === "detail" && <CoursesDetailPage {...Astro.props} />}

{/* Static Pages */}
{contentType === "about" && pageType === "static" && <AboutPage {...Astro.props} />}
{contentType === "feeds" && pageType === "static" && <FeedsPage {...Astro.props} />}
