---
/**
 * Unified Dynamic Routing - Books, Tutorials, Posts, Authors, Publishers & Genres (Phase 3 Migration)
 *
 * Handles all main content type pages:
 * - /en/books → Books list
 * - /es/libros → Books list
 * - /en/books/page/2 → Pagination
 * - /es/libros/pagina/2 → Pagination
 * - /en/books/my-book → Detail
 * - /es/libros/mi-libro → Detail
 * - /en/tutorials → Tutorials list
 * - /es/tutoriales → Tutorials list
 * - /en/tutorials/page/2 → Pagination
 * - /es/tutoriales/pagina/2 → Pagination
 * - /en/tutorials/my-tutorial → Detail
 * - /es/tutoriales/mi-tutorial → Detail
 * - /en/posts → Posts list (mixed content: posts + tutorials + books)
 * - /es/publicaciones → Posts list (mixed content)
 * - /en/posts/page/2 → Pagination (mixed content)
 * - /es/publicaciones/pagina/2 → Pagination (mixed content)
 * - /en/posts/my-post → Detail (posts collection only)
 * - /es/publicaciones/mi-post → Detail (posts collection only)
 * - /en/authors → Authors list
 * - /es/autores → Authors list
 * - /en/authors/author-slug → Author detail (with pagination)
 * - /es/autores/author-slug → Author detail (with pagination)
 * - /en/publishers → Publishers list
 * - /es/editoriales → Publishers list
 * - /en/publishers/publisher-slug → Publisher detail (with pagination)
 * - /es/editoriales/publisher-slug → Publisher detail (with pagination)
 * - /en/genres → Genres list
 * - /es/generos → Genres list
 * - /en/genres/genre-slug → Genre detail (with pagination)
 * - /es/generos/genre-slug → Genre detail (with pagination)
 *
 * This replaces:
 * Books:
 * - src/pages/en/books/index.astro
 * - src/pages/es/libros/index.astro
 * - src/pages/en/books/page/[page].astro
 * - src/pages/es/libros/pagina/[page].astro
 * - src/pages/en/books/[slug].astro
 * - src/pages/es/libros/[slug].astro
 *
 * Tutorials:
 * - src/pages/en/tutorials/index.astro
 * - src/pages/es/tutoriales/index.astro
 * - src/pages/en/tutorials/page/[page].astro
 * - src/pages/es/tutoriales/pagina/[page].astro
 * - src/pages/en/tutorials/[slug].astro
 * - src/pages/es/tutoriales/[slug].astro
 *
 * Posts:
 * - src/pages/en/posts/index.astro
 * - src/pages/es/publicaciones/index.astro
 * - src/pages/en/posts/page/[page].astro
 * - src/pages/es/publicaciones/pagina/[page].astro
 * - src/pages/en/posts/[slug].astro
 * - src/pages/es/publicaciones/[slug].astro
 *
 * Authors:
 * - src/pages/en/authors/index.astro
 * - src/pages/es/autores/index.astro
 * - src/pages/en/authors/[slug].astro
 * - src/pages/es/autores/[slug].astro
 *
 * Publishers:
 * - src/pages/en/publishers/index.astro
 * - src/pages/es/editoriales/index.astro
 * - src/pages/en/publishers/[slug].astro
 * - src/pages/es/editoriales/[slug].astro
 *
 * Genres:
 * - src/pages/en/genres/index.astro
 * - src/pages/es/generos/index.astro
 * - src/pages/en/genres/[slug].astro
 * - src/pages/es/generos/[slug].astro
 */

// Utils
import type { GetStaticPaths } from "astro";

// Contact data
import contactEn from "@/content/static/contact/en.json";
import contactEs from "@/content/static/contact/es.json";
// Import existing page templates - Books
import AuthorsDetailPage from "@/pages-templates/authors/AuthorsDetailPage.astro";
import AuthorsListPage from "@/pages-templates/authors/AuthorsListPage.astro";
import BooksDetailPage from "@/pages-templates/books/BooksDetailPage.astro";
import BooksListPage from "@/pages-templates/books/BooksListPage.astro";
import BooksPaginationPage from "@/pages-templates/books/BooksPaginationPage.astro";
import GenresDetailPage from "@/pages-templates/genres/GenresDetailPage.astro";
import GenresListPage from "@/pages-templates/genres/GenresListPage.astro";
// Import existing page templates - Tutorials
import PostsDetailPage from "@/pages-templates/posts/PostsDetailPage.astro";
import PostsListPage from "@/pages-templates/posts/PostsListPage.astro";
import PostsPaginationPage from "@/pages-templates/posts/PostsPaginationPage.astro";
import PublishersDetailPage from "@/pages-templates/publishers/PublishersDetailPage.astro";
import PublishersListPage from "@/pages-templates/publishers/PublishersListPage.astro";
import TutorialsDetailPage from "@/pages-templates/tutorials/TutorialsDetailPage.astro";
import TutorialsListPage from "@/pages-templates/tutorials/TutorialsListPage.astro";
import TutorialsPaginationPage from "@/pages-templates/tutorials/TutorialsPaginationPage.astro";
// Import existing page templates - Posts
// Import existing page templates - Authors
// Import existing page templates - Publishers
// Import existing page templates - Genres
import { paginateItems, getPageCount } from "@/utils/blog";
import { getAllBooksForLanguage, BOOKS_PER_PAGE, generateBookDetailPaths } from "@/utils/booksPages";
import { getAllContentForLanguage, POSTS_PER_PAGE, generatePostDetailPaths } from "@/utils/postsPages";
import { getLanguages } from "@/utils/routes";
import { generateItemListSchema } from "@/utils/schemas/itemList";
import {
  TAXONOMY_CONFIGS,
  getTaxonomyItemsWithCount,
  hasTargetContent as hasTargetTaxonomyContent,
  generateTaxonomyDetailPaths,
} from "@/utils/taxonomyPages";
import { getAllTutorialsForLanguage, TUTORIALS_PER_PAGE, generateTutorialDetailPaths } from "@/utils/tutorialsPages";

export const getStaticPaths: GetStaticPaths = async () => {
  const languages = getLanguages();
  const paths: { params: { lang: string; route: string }; props: Record<string, unknown> }[] = [];

  for (const lang of languages) {
    const contact = lang === "en" ? contactEn : contactEs;
    const targetLang = lang === "en" ? "es" : "en";

    // =================================================================
    // BOOKS
    // =================================================================
    {
      const routeSegment = lang === "en" ? "books" : "libros";
      const pageSegment = lang === "en" ? "page" : "pagina";

      // Get all books
      const sortedBooks = await getAllBooksForLanguage(lang);
      const targetBooks = await getAllBooksForLanguage(targetLang);
      const hasTargetContent = targetBooks.length > 0;
      const totalPages = getPageCount(sortedBooks.length, BOOKS_PER_PAGE);

      // 1. LIST PAGE
      const books = paginateItems(sortedBooks, 1, BOOKS_PER_PAGE);
      const itemListSchema = generateItemListSchema(
        books.map((book) => ({
          name: book.title,
          url: `/${lang}/${routeSegment}/${book.slug}/`,
          type: "Book",
          description: book.excerpt,
        })),
        "https://fjp.es",
      );

      paths.push({
        params: { lang, route: routeSegment },
        props: {
          contentType: "books",
          pageType: "list",
          lang,
          books,
          currentPage: 1,
          totalPages,
          itemListSchema,
          contact,
          hasTargetContent,
        },
      });

      // 2. PAGINATION PAGES
      for (let page = 2; page <= totalPages; page++) {
        const paginatedBooks = paginateItems(sortedBooks, page, BOOKS_PER_PAGE);

        paths.push({
          params: { lang, route: `${routeSegment}/${pageSegment}/${page}` },
          props: {
            contentType: "books",
            pageType: "pagination",
            lang,
            books: paginatedBooks,
            currentPage: page,
            totalPages,
            contact,
            hasTargetContent,
          },
        });
      }

      // 3. DETAIL PAGES
      const detailPaths = await generateBookDetailPaths(lang, contact);
      for (const { slug, props } of detailPaths) {
        paths.push({
          params: { lang, route: `${routeSegment}/${slug}` },
          props: {
            contentType: "books",
            pageType: "detail",
            ...props,
            hasTargetContent,
          },
        });
      }
    }

    // =================================================================
    // TUTORIALS
    // =================================================================
    {
      const routeSegment = lang === "en" ? "tutorials" : "tutoriales";
      const pageSegment = lang === "en" ? "page" : "pagina";

      // Get all tutorials
      const sortedTutorials = await getAllTutorialsForLanguage(lang);
      const targetTutorials = await getAllTutorialsForLanguage(targetLang);
      const hasTargetContent = targetTutorials.length > 0;
      const totalPages = getPageCount(sortedTutorials.length, TUTORIALS_PER_PAGE);

      // 1. LIST PAGE
      const tutorials = paginateItems(sortedTutorials, 1, TUTORIALS_PER_PAGE);
      const itemListSchema = generateItemListSchema(
        tutorials.map((tutorial) => ({
          name: tutorial.title,
          url: `/${lang}/${routeSegment}/${tutorial.slug}/`,
          type: "TechArticle",
          description: tutorial.excerpt,
        })),
        "https://fjp.es",
      );

      paths.push({
        params: { lang, route: routeSegment },
        props: {
          contentType: "tutorials",
          pageType: "list",
          lang,
          tutorials,
          currentPage: 1,
          totalPages,
          itemListSchema,
          contact,
          hasTargetContent,
        },
      });

      // 2. PAGINATION PAGES
      for (let page = 2; page <= totalPages; page++) {
        const paginatedTutorials = paginateItems(sortedTutorials, page, TUTORIALS_PER_PAGE);

        paths.push({
          params: { lang, route: `${routeSegment}/${pageSegment}/${page}` },
          props: {
            contentType: "tutorials",
            pageType: "pagination",
            lang,
            tutorials: paginatedTutorials,
            currentPage: page,
            totalPages,
            contact,
            hasTargetContent,
          },
        });
      }

      // 3. DETAIL PAGES
      const detailPaths = await generateTutorialDetailPaths(lang, contact);
      for (const { slug, props } of detailPaths) {
        paths.push({
          params: { lang, route: `${routeSegment}/${slug}` },
          props: {
            contentType: "tutorials",
            pageType: "detail",
            ...props,
            hasTargetContent,
          },
        });
      }
    }

    // =================================================================
    // POSTS (Mixed Content: posts + tutorials + books timeline)
    // =================================================================
    {
      const routeSegment = lang === "en" ? "posts" : "publicaciones";
      const pageSegment = lang === "en" ? "page" : "pagina";

      // Get all content (posts, tutorials, books combined)
      const sortedContent = await getAllContentForLanguage(lang);
      const targetContent = await getAllContentForLanguage(targetLang);
      const hasTargetContent = targetContent.length > 0;
      const totalPages = getPageCount(sortedContent.length, POSTS_PER_PAGE);

      // 1. LIST PAGE
      const posts = paginateItems(sortedContent, 1, POSTS_PER_PAGE);

      // Generate ItemList schema for mixed content
      const itemListSchema = generateItemListSchema(
        posts.map((post) => {
          // Map content type to Schema.org type
          const schemaType = post.type === "book" ? "Book" : post.type === "tutorial" ? "TechArticle" : "BlogPosting";

          // Map to correct route segment
          const routeKey = post.type === "book" ? "books" : post.type === "tutorial" ? "tutorials" : "posts";

          return {
            name: post.title,
            url: `/${lang}/${
              lang === "en"
                ? routeKey
                : routeKey === "books"
                  ? "libros"
                  : routeKey === "tutorials"
                    ? "tutoriales"
                    : "publicaciones"
            }/${post.slug}/`,
            type: schemaType,
            description: post.excerpt,
          };
        }),
        "https://fjp.es",
      );

      paths.push({
        params: { lang, route: routeSegment },
        props: {
          contentType: "posts",
          pageType: "list",
          lang,
          posts,
          currentPage: 1,
          totalPages,
          itemListSchema,
          contact,
          hasTargetContent,
        },
      });

      // 2. PAGINATION PAGES
      for (let page = 2; page <= totalPages; page++) {
        const paginatedPosts = paginateItems(sortedContent, page, POSTS_PER_PAGE);

        paths.push({
          params: { lang, route: `${routeSegment}/${pageSegment}/${page}` },
          props: {
            contentType: "posts",
            pageType: "pagination",
            lang,
            posts: paginatedPosts,
            currentPage: page,
            totalPages,
            contact,
            hasTargetContent,
          },
        });
      }

      // 3. DETAIL PAGES (only for "posts" collection, not books/tutorials)
      const postDetailPaths = await generatePostDetailPaths(lang, contact);
      for (const { slug, props } of postDetailPaths) {
        paths.push({
          params: { lang, route: `${routeSegment}/${slug}` },
          props: {
            contentType: "posts",
            pageType: "detail",
            ...props,
            hasTargetContent,
          },
        });
      }
    }

    // =================================================================
    // AUTHORS (Taxonomy)
    // =================================================================
    {
      const config = TAXONOMY_CONFIGS.authors;
      const routeSegment = lang === "en" ? "authors" : "autores";

      // Get all authors with counts
      const authorsData = await getTaxonomyItemsWithCount(config, lang);
      const itemsWithContent = authorsData
        .filter(({ count }) => count > 0)
        .sort((a, b) => a.item.data.name.localeCompare(b.item.data.name));

      // Check if target language has content
      const hasTargetContent = await hasTargetTaxonomyContent(config, targetLang);

      // 1. LIST PAGE (no pagination, shows all authors)
      paths.push({
        params: { lang, route: routeSegment },
        props: {
          contentType: "authors",
          pageType: "list",
          lang,
          itemsWithContent,
          contact,
          hasTargetContent,
        },
      });

      // 2. DETAIL PAGES (with pagination for books)
      const detailPaths = await generateTaxonomyDetailPaths(config, lang, contact);
      for (const { slug, props } of detailPaths) {
        // Add authorsWithCounts to props for sidebar
        const enhancedProps = {
          ...props,
          authorsWithCounts: itemsWithContent,
        };

        paths.push({
          params: { lang, route: `${routeSegment}/${slug}` },
          props: {
            contentType: "authors",
            pageType: "detail",
            ...enhancedProps,
          },
        });
      }
    }

    // =================================================================
    // PUBLISHERS (Taxonomy)
    // =================================================================
    {
      const config = TAXONOMY_CONFIGS.publishers;
      const routeSegment = lang === "en" ? "publishers" : "editoriales";

      // Get all publishers with counts
      const publishersData = await getTaxonomyItemsWithCount(config, lang);
      const itemsWithContent = publishersData
        .filter(({ count }) => count > 0)
        .sort((a, b) => a.item.data.name.localeCompare(b.item.data.name));

      // Check if target language has content
      const hasTargetContent = await hasTargetTaxonomyContent(config, targetLang);

      // 1. LIST PAGE (no pagination, shows all publishers)
      paths.push({
        params: { lang, route: routeSegment },
        props: {
          contentType: "publishers",
          pageType: "list",
          lang,
          itemsWithContent,
          contact,
          hasTargetContent,
        },
      });

      // 2. DETAIL PAGES (with pagination for books)
      const detailPaths = await generateTaxonomyDetailPaths(config, lang, contact);
      for (const { slug, props } of detailPaths) {
        // Add publishersWithCounts to props for sidebar
        const enhancedProps = {
          ...props,
          publishersWithCounts: itemsWithContent,
        };

        paths.push({
          params: { lang, route: `${routeSegment}/${slug}` },
          props: {
            contentType: "publishers",
            pageType: "detail",
            ...enhancedProps,
          },
        });
      }
    }

    // =================================================================
    // GENRES (Taxonomy)
    // =================================================================
    {
      const config = TAXONOMY_CONFIGS.genres;
      const routeSegment = lang === "en" ? "genres" : "generos";

      // Get all genres with counts
      const genresData = await getTaxonomyItemsWithCount(config, lang);
      const itemsWithContent = genresData
        .filter(({ count }) => count > 0)
        .sort((a, b) => a.item.data.name.localeCompare(b.item.data.name));

      // Check if target language has content
      const hasTargetContent = await hasTargetTaxonomyContent(config, targetLang);

      // 1. LIST PAGE (no pagination, shows all genres)
      paths.push({
        params: { lang, route: routeSegment },
        props: {
          contentType: "genres",
          pageType: "list",
          lang,
          itemsWithContent,
          contact,
          hasTargetContent,
        },
      });

      // 2. DETAIL PAGES (with pagination for books)
      const detailPaths = await generateTaxonomyDetailPaths(config, lang, contact);
      for (const { slug, props } of detailPaths) {
        // Add genresWithCounts to props for sidebar
        const enhancedProps = {
          ...props,
          genresWithCounts: itemsWithContent,
        };

        paths.push({
          params: { lang, route: `${routeSegment}/${slug}` },
          props: {
            contentType: "genres",
            pageType: "detail",
            ...enhancedProps,
          },
        });
      }
    }
  }

  console.log(
    `[Unified Routing] Generated ${paths.length} paths (books + tutorials + posts + authors + publishers + genres)`,
  );
  return paths;
};

const { pageType, contentType } = Astro.props;
---

{/* Books */}
{contentType === "books" && pageType === "list" && <BooksListPage {...Astro.props} />}
{contentType === "books" && pageType === "pagination" && <BooksPaginationPage {...Astro.props} />}
{contentType === "books" && pageType === "detail" && <BooksDetailPage {...Astro.props} />}

{/* Tutorials */}
{contentType === "tutorials" && pageType === "list" && <TutorialsListPage {...Astro.props} />}
{contentType === "tutorials" && pageType === "pagination" && <TutorialsPaginationPage {...Astro.props} />}
{contentType === "tutorials" && pageType === "detail" && <TutorialsDetailPage {...Astro.props} />}

{/* Posts */}
{contentType === "posts" && pageType === "list" && <PostsListPage {...Astro.props} />}
{contentType === "posts" && pageType === "pagination" && <PostsPaginationPage {...Astro.props} />}
{contentType === "posts" && pageType === "detail" && <PostsDetailPage {...Astro.props} />}

{/* Authors */}
{contentType === "authors" && pageType === "list" && <AuthorsListPage {...Astro.props} />}
{contentType === "authors" && pageType === "detail" && <AuthorsDetailPage {...Astro.props} />}

{/* Publishers */}
{contentType === "publishers" && pageType === "list" && <PublishersListPage {...Astro.props} />}
{contentType === "publishers" && pageType === "detail" && <PublishersDetailPage {...Astro.props} />}

{/* Genres */}
{contentType === "genres" && pageType === "list" && <GenresListPage {...Astro.props} />}
{contentType === "genres" && pageType === "detail" && <GenresDetailPage {...Astro.props} />}
