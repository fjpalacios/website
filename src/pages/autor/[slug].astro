---
import BookList from "@components/BookList.astro";
import Layout from "@layouts/Layout.astro";
import { getCollection } from "astro:content";

import contactEs from "@/content/static/contact/es.json";
import { getBooksByAuthor, prepareAuthorSummary, prepareBookSummary, sortByDate } from "@/utils/blog";

export async function getStaticPaths() {
  const authors = await getCollection("authors");

  return authors.map((author) => ({
    params: { slug: author.data.author_slug },
    props: { authorEntry: author },
  }));
}

const { authorEntry } = Astro.props;
const author = prepareAuthorSummary(authorEntry);

// Get all books and filter by this author
const allBooks = await getCollection("books");
const authorBooks = getBooksByAuthor(allBooks, author.slug);

// Sort by date (newest first)
const sortedBooks = sortByDate(authorBooks, "desc");

// Prepare book summaries
const bookSummaries = sortedBooks.map((book) => prepareBookSummary(book, authorEntry));

// Calculate author stats
const totalBooks = bookSummaries.length;
const averageRating =
  totalBooks > 0 ? (bookSummaries.reduce((sum, book) => sum + book.score, 0) / totalBooks).toFixed(1) : 0;
const totalPages = bookSummaries.reduce((sum, book) => sum + book.pages, 0);

const currentYear = new Date().getFullYear();
const authorAge = author.birthYear ? currentYear - author.birthYear : null;
---

<Layout lang={author.language} title={`${author.name} - Author Page`} contact={contactEs}>
  <a href="/libros" class="back-link">â† Back to books</a>

  <div class="author__header">
    <h1 class="author__name">{author.name}</h1>

    <div class="author__meta">
      {
        author.nationality && (
          <div class="author__meta-item">
            <span>ğŸŒ</span>
            <span>{author.nationality}</span>
          </div>
        )
      }

      {
        author.birthYear && (
          <div class="author__meta-item">
            <span>ğŸ“…</span>
            <span>
              Born {author.birthYear}
              {authorAge && !author.deathYear && ` (${authorAge} years old)`}
            </span>
          </div>
        )
      }

      {
        author.deathYear && (
          <div class="author__meta-item">
            <span>â€ </span>
            <span>Died {author.deathYear}</span>
          </div>
        )
      }
    </div>

    <p class="author__bio">{author.bio}</p>

    {
      (author.website || author.twitter || author.goodreads || author.wikipedia) && (
        <div class="author__links">
          {author.website && (
            <a href={author.website} target="_blank" rel="noopener noreferrer" class="author__link">
              ğŸŒ Website
            </a>
          )}
          {author.twitter && (
            <a
              href={`https://twitter.com/${author.twitter.replace("@", "")}`}
              target="_blank"
              rel="noopener noreferrer"
              class="author__link"
            >
              ğŸ¦ Twitter
            </a>
          )}
          {author.goodreads && (
            <a href={author.goodreads} target="_blank" rel="noopener noreferrer" class="author__link">
              ğŸ“š Goodreads
            </a>
          )}
          {author.wikipedia && (
            <a href={author.wikipedia} target="_blank" rel="noopener noreferrer" class="author__link">
              ğŸ“– Wikipedia
            </a>
          )}
        </div>
      )
    }
  </div>

  {
    totalBooks > 0 && (
      <div class="stats-section">
        <div class="stat-card">
          <span class="stat-card__value">{totalBooks}</span>
          <span class="stat-card__label">Books Reviewed</span>
        </div>

        <div class="stat-card">
          <span class="stat-card__value">{averageRating}â­</span>
          <span class="stat-card__label">Average Rating</span>
        </div>

        <div class="stat-card">
          <span class="stat-card__value">{totalPages.toLocaleString()}</span>
          <span class="stat-card__label">Total Pages</span>
        </div>
      </div>
    )
  }

  <h2 class="section-title">Books by {author.name}</h2>

  {
    bookSummaries.length > 0 ? (
      <BookList books={bookSummaries} totalBooks={totalBooks} />
    ) : (
      <div class="empty-state">
        <div class="empty-state__icon">ğŸ“š</div>
        <h3 class="empty-state__title">No books reviewed yet</h3>
        <p class="empty-state__text">We haven't reviewed any books by {author.name} yet. Check back soon!</p>
      </div>
    )
  }
</Layout>
