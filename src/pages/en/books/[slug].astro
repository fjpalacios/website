---
import AuthorInfo from "@components/AuthorInfo.astro";
import PostTitle from "@components/PostTitle.astro";
import SectionTitle from "@components/SectionTitle.astro";
import Share from "@components/Share.astro";
import Layout from "@layouts/Layout.astro";
import { t } from "@locales";
import { buildAuthorUrl, buildPublisherUrl, buildGenreUrl, buildCategoryUrl, buildScoreUrl } from "@utils/routes";
import { getCollection, render } from "astro:content";

import contactEn from "@/content/static/contact/en.json";
import { findAuthorBySlug, findPublisherBySlug, findGenresBySlug, findCategoriesBySlug } from "@/utils/blog";
import { generateBookDetailPaths } from "@/utils/booksPages";

export async function getStaticPaths() {
  const paths = await generateBookDetailPaths("en", contactEn);
  return paths.map(({ slug, props }) => ({
    params: { slug },
    props,
  }));
}

const { bookEntry, lang, contact } = Astro.props;
const book = bookEntry.data;
const { Content } = await render(bookEntry);

// Get related data
const allAuthors = await getCollection("authors");
const allPublishers = await getCollection("publishers");
const allGenres = await getCollection("genres");
const allCategories = await getCollection("categories");

const author = findAuthorBySlug(allAuthors, book.author, "en");
const publisher = book.publisher ? findPublisherBySlug(allPublishers, book.publisher) : null;
const genres = findGenresBySlug(allGenres, book.genres);
const categories = findCategoriesBySlug(allCategories, book.categories);

const authorWithGender = author?.data.gender === "male" ? "The author" : "The author";

// Score rendering with emojis
const renderScoreEmoji = () => {
  if (book.score === "fav") {
    return "‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è";
  }
  const stars = "‚≠ê".repeat(book.score);
  const emptyStars = "‚òÜ".repeat(5 - book.score);
  return stars + emptyStars;
};

const scoreEmoji = renderScoreEmoji();

// Share component data
const baseUrl = t(lang, "metaData.url");
const currentUrl = new URL(Astro.url.pathname, baseUrl).href;
const twitterUsername = t(lang, "metaData.twitterUsername");
---

<Layout lang={lang} title={`${book.title} - Book Review`} contact={contact} translationSlug={book.i18n}>
  <main class="book">
    <section class="book__content">
      <div class="book__content__cover">
        <img src={book.book_cover || book.cover} alt={book.title} />
        <div class="score">{scoreEmoji}</div>
      </div>
      <div class="book__content__content">
        <PostTitle title={book.title} date={book.date} lang={lang} />
        <div class="book__content__content__data">
          <div class="book__content__content__data_pages">
            <strong>Pages</strong>: {book.pages}
          </div>
          <div class="book__content__content__data__isbn">
            {
              book.isbn ? (
                <>
                  <strong>ISBN</strong>: {book.isbn}
                </>
              ) : book.asin ? (
                <>
                  <strong>ASIN</strong>: {book.asin}
                </>
              ) : null
            }
          </div>
          {
            book.buy && book.buy.length > 0 && (
              <div class="book__content__content__data__buy">
                <strong>Buy</strong>:
                <ul>
                  {book.buy.map((buyLink) => (
                    <li>
                      <a href={buyLink.link} target="_blank" rel="nofollow">
                        {buyLink.type === "paper" ? "Paperback" : buyLink.type === "ebook" ? "eBook" : "Audiobook"}
                      </a>
                    </li>
                  ))}
                </ul>
              </div>
            )
          }
          {
            publisher && (
              <div class="book__content__content__data__publisher">
                <strong>Publisher</strong>:
                <ul>
                  <li>
                    <a href={buildPublisherUrl(lang, publisher.data.publisher_slug)}>{publisher.data.name}</a>
                  </li>
                  {book.book_card && (
                    <li>
                      <a href={book.book_card} target="_blank" rel="nofollow">
                        Book details
                      </a>
                    </li>
                  )}
                </ul>
              </div>
            )
          }
        </div>
        <SectionTitle title="Synopsis" />
        <div class="text-area">
          <p>{book.synopsis}</p>
        </div>
        {author && <SectionTitle title={authorWithGender} />}
        {author && <AuthorInfo author={author} border={false} />}
        <SectionTitle title="Review" />
        <div class="text-area">
          <Content />
        </div>
      </div>
    </section>
    <section class="book__info">
      <div class="book__info__icon">üìö</div>
      <ul class="book__info__text">
        {
          author && (
            <li>
              <a href={buildAuthorUrl(lang, author.data.author_slug)} title={authorWithGender}>
                {author.data.name}
              </a>
            </li>
          )
        }
        {
          publisher && (
            <li>
              <a href={buildPublisherUrl(lang, publisher.data.publisher_slug)}>{publisher.data.name}</a>
            </li>
          )
        }
        <li>
          <a href={buildScoreUrl(lang, book.score)} title="Score">
            {book.score === "fav" ? "Favorite" : `${book.score}/5`}
          </a>
        </li>
      </ul>
    </section>
    <section class="book__info">
      <div class="book__info__icon">üè∑Ô∏è</div>
      <ul class="book__info__text">
        {
          categories.map((category) => (
            <li>
              <a
                href={buildCategoryUrl(lang, category.data.category_slug)}
                class="book__info__text__item"
                title="Category"
              >
                {category.data.name}
              </a>
            </li>
          ))
        }
      </ul>
    </section>
    {
      genres.length > 0 && (
        <section class="book__info">
          <div class="book__info__icon">üîñ</div>
          <ul class="book__info__text">
            {genres.map((genre) => (
              <li>
                <a href={buildGenreUrl(lang, genre.data.genre_slug)} title="Genre">
                  {genre.data.name}
                </a>
              </li>
            ))}
          </ul>
        </section>
      )
    }
  </main>
  <Share title={book.title} url={currentUrl} lang={lang} twitterUsername={twitterUsername} />
</Layout>
