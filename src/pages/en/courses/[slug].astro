---
import Breadcrumbs, { type BreadcrumbItem } from "@components/Breadcrumbs.astro";
import Paginator from "@components/Paginator.astro";
import PostList from "@components/PostList.astro";
import TaxonomyList from "@components/TaxonomyList.astro";
import Title from "@components/Title.astro";
import Layout from "@layouts/Layout.astro";
import { t } from "@locales";
import { buildCourseUrl, buildCoursesIndexUrl } from "@utils/routes";

import contactEn from "@/content/static/contact/en.json";
import { generateItemListSchema } from "@/utils/schemas/itemList";
import { TAXONOMY_CONFIGS, generateTaxonomyDetailPaths, getTaxonomyItemsWithCount } from "@/utils/taxonomyPages";

export async function getStaticPaths() {
  const config = TAXONOMY_CONFIGS.courses;
  const paths = await generateTaxonomyDetailPaths(config, "en", contactEn);

  return paths.map(({ slug, page, props }) => ({
    params: { slug, page },
    props,
  }));
}

const { taxonomyItem: course, content, currentPage, totalPages, lang, contact, hasTargetContent } = Astro.props;

// Get all courses with counts for sidebar
const config = TAXONOMY_CONFIGS.courses;
const coursesData = await getTaxonomyItemsWithCount(config, lang);
const coursesWithCounts = coursesData.sort((a, b) => a.item.data.name.localeCompare(b.item.data.name));

const pageTitle = `${t(lang, "pages.course")}: ${course.data.name}`;
const basePath = buildCourseUrl(lang, course.data.course_slug);

// Build breadcrumbs
const breadcrumbs: BreadcrumbItem[] = [
  { label: t(lang, "pages.home"), url: `/${lang}` },
  { label: t(lang, "pages.courses"), url: buildCoursesIndexUrl(lang) },
  { label: course.data.name }, // Current page, no URL
];

// Generate ItemList schema for SEO
const itemListSchema = generateItemListSchema(
  content.map((item) => {
    const schemaType = item.type === "book" ? "Book" : item.type === "tutorial" ? "TechArticle" : "BlogPosting";
    const routeKey = item.type === "book" ? "books" : item.type === "tutorial" ? "tutorials" : "posts";
    return {
      name: item.title,
      url: `/${lang}/${t(lang, `routes.${routeKey}`)}/${item.slug}/`,
      type: schemaType,
      description: item.excerpt,
    };
  }),
  Astro.site ? Astro.site.toString() : "https://fjp.es",
);
---

<Layout
  lang={lang}
  title={pageTitle}
  contact={contact}
  translationSlug={course.data.i18n}
  hasTargetContent={hasTargetContent}
>
  <script type="application/ld+json" set:html={JSON.stringify(itemListSchema)} />

  <Breadcrumbs items={breadcrumbs} lang={lang} />
  <Title title={pageTitle} srOnly={true} />

  {
    course.data.description && (
      <div class="course-description">
        <p>{course.data.description}</p>
      </div>
    )
  }

  <PostList posts={content} lang={lang} />
  <Paginator currentPage={currentPage} totalPages={totalPages} basePath={basePath} lang={lang} />
  <TaxonomyList
    items={coursesWithCounts}
    title={t(lang, "allCourses")}
    lang={lang}
    routeKey="courses"
    slugField="course_slug"
  />
</Layout>
