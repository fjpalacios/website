---
import Paginator from "@components/Paginator.astro";
import PostList from "@components/PostList.astro";
import Title from "@components/Title.astro";
import Layout from "@layouts/Layout.astro";
import { t } from "@locales";

import contactEn from "@/content/static/contact/en.json";
import { paginateItems, getPageCount } from "@/utils/blog";
import { getAllContentForLanguage, POSTS_PER_PAGE } from "@/utils/postsPages";
import { generateItemListSchema } from "@/utils/schemas/itemList";

const lang = "en";
const currentPage = 1;
const sortedContent = await getAllContentForLanguage(lang);
const totalPages = getPageCount(sortedContent.length, POSTS_PER_PAGE);
const posts = paginateItems(sortedContent, currentPage, POSTS_PER_PAGE);

// Check if alternate language version has content (for language switcher)
const targetLang = "es";
const targetContent = await getAllContentForLanguage(targetLang);
const hasTargetContent = targetContent.length > 0;

const pageTitle = "ðŸ“ " + t(lang, "pages.posts");
const pageDescription = "Articles, tutorials and book reviews";

// Generate ItemList schema for SEO
const itemListSchema = generateItemListSchema(
  posts.map((post) => {
    // Map content type to Schema.org type
    const schemaType = post.type === "book" ? "Book" : post.type === "tutorial" ? "TechArticle" : "BlogPosting";
    const routeKey = post.type === "book" ? "books" : post.type === "tutorial" ? "tutorials" : "posts";

    return {
      name: post.title,
      url: `/${lang}/${t(lang, `routes.${routeKey}`)}/${post.slug}/`,
      type: schemaType,
      description: post.excerpt,
    };
  }),
  Astro.site ? Astro.site.toString() : "https://fjp.es",
);
---

<Layout
  lang={lang}
  title={pageTitle}
  description={pageDescription}
  contact={contactEn}
  hasTargetContent={hasTargetContent}
>
  <Title title={pageTitle} />

  <div data-pagefind-ignore>
    <script type="application/ld+json" set:html={JSON.stringify(itemListSchema)} />

    {
      posts.length > 0 ? (
        <PostList posts={posts} lang={lang} />
      ) : (
        <div class="empty-state">
          <p>{t(lang, "emptyState.posts")}</p>
        </div>
      )
    }
  </div>

  <Paginator currentPage={currentPage} totalPages={totalPages} basePath="/en/posts" lang={lang} />
</Layout>
