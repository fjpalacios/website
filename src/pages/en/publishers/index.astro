---
import PublisherList from "@components/PublisherList.astro";
import Title from "@components/Title.astro";
import Layout from "@layouts/Layout.astro";
import { t } from "@locales";
import { getCollection } from "astro:content";

import contactEn from "@/content/static/contact/en.json";

const lang = "en";

// Get all publishers in English
const allPublishers = await getCollection("publishers");
const englishPublishers = allPublishers.filter((publisher) => publisher.data.language === lang);

// Get all books in English to count items per publisher
const allBooks = await getCollection("books");
const englishBooks = allBooks.filter((book) => book.data.language === lang);

// Check if target language (Spanish) has publishers with books
const targetLang = "es";
const targetPublishers = allPublishers.filter((publisher) => publisher.data.language === targetLang);
const targetBooks = allBooks.filter((book) => book.data.language === targetLang);

const hasTargetContent = targetPublishers.some((publisher) => {
  const count = targetBooks.filter((book) => book.data.publisher === publisher.data.publisher_slug).length;
  return count > 0;
});

// Count books per publisher
const publishersWithCount = englishPublishers.map((publisher) => {
  const count = englishBooks.filter((book) => book.data.publisher === publisher.data.publisher_slug).length;
  return { publisher, count };
});

// Filter publishers with content
const publishersWithContent = publishersWithCount.filter(({ count }) => count > 0);

// Sort by name
publishersWithContent.sort((a, b) => a.publisher.data.name.localeCompare(b.publisher.data.name));

const pageTitle = `ğŸ¢ ${t(lang, "pages.publishers")}`;
const pageDescription = t(lang, "allPublishers");
---

<Layout
  lang={lang}
  title={pageTitle}
  description={pageDescription}
  contact={contactEn}
  hasTargetContent={hasTargetContent}
>
  <Title title={pageTitle} />

  {
    publishersWithContent.length > 0 ? (
      <PublisherList publishers={publishersWithContent} title={t(lang, "allPublishers")} lang={lang} showCount={true} />
    ) : (
      <div class="empty-state">
        <p>{t(lang, "emptyState.publishers")}</p>
      </div>
    )
  }
</Layout>

<style lang="scss">
  @use "@/styles/variables" as *;

  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: $cursive-color;
  }
</style>
