---
import PostList from "@components/PostList.astro";
import Title from "@components/Title.astro";
import Layout from "@layouts/Layout.astro";
import { getCollection } from "astro:content";

import contactEn from "@/content/static/contact/en.json";
import {
  sortByDate,
  filterByLanguage,
  paginateItems,
  getPageCount,
  prepareTutorialSummary,
  type TutorialSummary,
} from "@/utils/blog";

const TUTORIALS_PER_PAGE = 12;
const lang = "en";

// Get all tutorials
const allTutorials = await getCollection("tutorials");

// Filter by English language
const englishTutorials = filterByLanguage(allTutorials, lang);

// Sort by date (newest first)
const sortedTutorials = sortByDate(englishTutorials, "desc");

// Prepare tutorial summaries
const tutorialSummaries: TutorialSummary[] = sortedTutorials.map((tutorial) => prepareTutorialSummary(tutorial));

// Paginate
const currentPage = 1;
const totalPages = getPageCount(tutorialSummaries.length, TUTORIALS_PER_PAGE);
const paginatedTutorials = paginateItems(tutorialSummaries, currentPage, TUTORIALS_PER_PAGE);

const pageTitle = "Tutorials";
const pageDescription = "Web development tutorials and guides";
---

<Layout lang={lang} title={pageTitle} description={pageDescription} contact={contactEn} translationSlug="">
  <Title title={pageTitle} />

  <div class="tutorial-stats">
    Showing <strong>{paginatedTutorials.length}</strong> of
    <strong>{tutorialSummaries.length}</strong> tutorials
    {
      totalPages > 1 && (
        <span>
          {" "}
          (page {currentPage} of {totalPages})
        </span>
      )
    }
  </div>

  {
    paginatedTutorials.length > 0 ? (
      <PostList posts={paginatedTutorials} lang={lang} />
    ) : (
      <div class="empty-state">
        <p>No tutorials found. Check back soon!</p>
      </div>
    )
  }

  {
    totalPages > 1 && (
      <nav class="pagination">
        {Array.from({ length: totalPages }, (_, i) => i + 1).map((page) => (
          <a
            href={page === 1 ? "/en/tutorials" : `/en/tutorials/page/${page}`}
            class:list={["page-link", { active: page === currentPage }]}
          >
            {page}
          </a>
        ))}
      </nav>
    )
  }
</Layout>

<style lang="scss">
  @use "@/styles/mixins" as *;
  @use "@/styles/variables" as *;

  .tutorial-stats {
    grid-column: span 12;
    margin-bottom: 2rem;
    padding: 1rem;
    background: $primary;
    color: $text;
    border-radius: 4px;

    strong {
      color: $accent;
      font-weight: bold;
    }
  }

  .empty-state {
    grid-column: span 12;
    text-align: center;
    padding: 4rem 2rem;
    color: $cursive-color;
  }

  .pagination {
    grid-column: span 12;
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 2rem;

    .page-link {
      padding: 0.5rem 1rem;
      background: $primary;
      color: $text;
      border: 1px solid $primary;
      text-decoration: none;
      transition: all 0.2s ease;

      &:hover {
        background: $accent;
        color: $background;
        border-color: $accent;
      }

      &.active {
        background: $accent;
        color: $background;
        font-weight: bold;
      }
    }
  }
</style>
