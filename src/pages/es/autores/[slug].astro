---
import AuthorInfo from "@components/AuthorInfo.astro";
import AuthorList from "@components/AuthorList.astro";
import Paginator from "@components/Paginator.astro";
import PostList from "@components/PostList.astro";
import Title from "@components/Title.astro";
import Layout from "@layouts/Layout.astro";
import { t } from "@locales";
import { buildAuthorUrl } from "@utils/routes";

import contactEs from "@/content/static/contact/es.json";
import { TAXONOMY_CONFIGS, generateTaxonomyDetailPaths, getTaxonomyItemsWithCount } from "@/utils/taxonomyPages";

export async function getStaticPaths() {
  const config = TAXONOMY_CONFIGS.authors;
  const paths = await generateTaxonomyDetailPaths(config, "es", contactEs);

  return paths.map(({ slug, page, props }) => ({
    params: { slug, page },
    props,
  }));
}

const { taxonomyItem: author, content, currentPage, totalPages, lang, contact } = Astro.props;

// Get all authors with counts for sidebar
const config = TAXONOMY_CONFIGS.authors;
const authorsData = await getTaxonomyItemsWithCount(config, lang);
const authorsWithCounts = authorsData
  .filter(({ count }) => count > 0)
  .sort((a, b) => a.item.data.name.localeCompare(b.item.data.name))
  .map(({ item, count }) => ({ author: item, count }));

// Get gender-specific title
const authorTitle = author.data.gender === "male" ? t(lang, "pages.authorMale") : t(lang, "pages.authorFemale");
const pageTitle = `${authorTitle}: ${author.data.name}`;
const basePath = buildAuthorUrl(lang, author.data.author_slug);

// SEO description
const description = `${content.length} ${content.length === 1 ? "libro" : "libros"} de ${author.data.name} rese√±ados en el blog`;
---

<Layout lang={lang} title={pageTitle} description={description} contact={contact}>
  <Title title={pageTitle} />

  <div class="space" style="margin-bottom: 20px;">
    <AuthorInfo author={author} border={true} />
  </div>

  <PostList posts={content} lang={lang} />

  <Paginator currentPage={currentPage} totalPages={totalPages} basePath={basePath} lang={lang} />

  <AuthorList authors={authorsWithCounts} title={t(lang, "allAuthors")} lang={lang} showCount={true} />
</Layout>
