---
import CourseList from "@components/CourseList.astro";
import Paginator from "@components/Paginator.astro";
import PostList from "@components/PostList.astro";
import SectionTitle from "@components/SectionTitle.astro";
import Layout from "@layouts/Layout.astro";
import { t } from "@locales";
import { buildCourseUrl } from "@utils/routes";

import contactEs from "@/content/static/contact/es.json";
import { TAXONOMY_CONFIGS, generateTaxonomyDetailPaths, getTaxonomyItemsWithCount } from "@/utils/taxonomyPages";

export async function getStaticPaths() {
  const config = TAXONOMY_CONFIGS.courses;
  const paths = await generateTaxonomyDetailPaths(config, "es", contactEs);

  return paths.map(({ slug, page, props }) => ({
    params: { slug, page },
    props,
  }));
}

const { taxonomyItem: course, content, currentPage, totalPages, lang, contact } = Astro.props;

// Get all courses with counts for sidebar
const config = TAXONOMY_CONFIGS.courses;
const coursesData = await getTaxonomyItemsWithCount(config, lang);
const coursesWithCounts = coursesData
  .sort((a, b) => a.item.data.name.localeCompare(b.item.data.name))
  .map(({ item, count }) => ({ course: item, count }));

const pageTitle = `${t(lang, "pages.course")}: ${course.data.name}`;
const basePath = buildCourseUrl(lang, course.data.course_slug);
---

<Layout lang={lang} title={pageTitle} contact={contact} translationSlug={course.data.i18n}>
  <SectionTitle title={pageTitle} />

  {
    course.data.description && (
      <div class="course-description">
        <p>{course.data.description}</p>
      </div>
    )
  }

  <PostList posts={content} lang={lang} />
  <Paginator currentPage={currentPage} totalPages={totalPages} basePath={basePath} lang={lang} />
  <CourseList courses={coursesWithCounts} title={t(lang, "allCourses")} lang={lang} />
</Layout>
