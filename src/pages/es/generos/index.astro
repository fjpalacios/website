---
import GenreList from "@components/GenreList.astro";
import Title from "@components/Title.astro";
import Layout from "@layouts/Layout.astro";
import { t } from "@locales";
import { getCollection } from "astro:content";

import contactEs from "@/content/static/contact/es.json";

const lang = "es";

// Get all genres in Spanish
const allGenres = await getCollection("genres");
const spanishGenres = allGenres.filter((genre) => genre.data.language === lang);

// Get all books in Spanish to count items per genre
const allBooks = await getCollection("books");
const spanishBooks = allBooks.filter((book) => book.data.language === lang);

// Check if target language (English) has genres with books
const targetLang = "en";
const targetGenres = allGenres.filter((genre) => genre.data.language === targetLang);
const targetBooks = allBooks.filter((book) => book.data.language === targetLang);

const hasTargetContent = targetGenres.some((genre) => {
  const count = targetBooks.filter((book) => book.data.genres?.includes(genre.data.genre_slug)).length;
  return count > 0;
});

// Count books per genre
const genresWithCount = spanishGenres.map((genre) => {
  const count = spanishBooks.filter((book) => book.data.genres?.includes(genre.data.genre_slug)).length;
  return { genre, count };
});

// Sort by name
genresWithCount.sort((a, b) => a.genre.data.name.localeCompare(b.genre.data.name));

const pageTitle = `ðŸ“š ${t(lang, "pages.genres")}`;
const pageDescription = t(lang, "allGenres");
---

<Layout
  lang={lang}
  title={pageTitle}
  description={pageDescription}
  contact={contactEs}
  hasTargetContent={hasTargetContent}
>
  <Title title={pageTitle} />

  <GenreList genres={genresWithCount} title={t(lang, "allGenres")} lang={lang} showCount={true} />
</Layout>
