---
import AuthorInfo from "@components/AuthorInfo.astro";
import Breadcrumbs, { type BreadcrumbItem } from "@components/Breadcrumbs.astro";
import PostTitle from "@components/PostTitle.astro";
import SectionTitle from "@components/SectionTitle.astro";
import Share from "@components/Share.astro";
import Layout from "@layouts/Layout.astro";
import { t } from "@locales";
import {
  buildAuthorUrl,
  buildPublisherUrl,
  buildGenreUrl,
  buildCategoryUrl,
  buildScoreUrl,
  buildBooksIndexUrl,
} from "@utils/routes";
import { getCollection, render } from "astro:content";

import contactEs from "@/content/static/contact/es.json";
import { findAuthorBySlug, findPublisherBySlug, findGenresBySlug, findCategoriesBySlug } from "@/utils/blog";
import { generateBookDetailPaths } from "@/utils/booksPages";

export async function getStaticPaths() {
  const paths = await generateBookDetailPaths("es", contactEs);
  return paths.map(({ slug, props }) => ({
    params: { slug },
    props,
  }));
}

const { bookEntry, lang, contact } = Astro.props;
const book = bookEntry.data;
const { Content } = await render(bookEntry);

// Get related data
const allAuthors = await getCollection("authors");
const allPublishers = await getCollection("publishers");
const allGenres = await getCollection("genres");
const allCategories = await getCollection("categories");

const author = findAuthorBySlug(allAuthors, book.author, "es");
const publisher = book.publisher ? findPublisherBySlug(allPublishers, book.publisher) : null;
const genres = findGenresBySlug(allGenres, book.genres);
const categories = findCategoriesBySlug(allCategories, book.categories);

const authorWithGender = author?.data.gender === "male" ? "El autor" : "La autora";

// Score rendering with Unicode stars
const renderScoreEmoji = () => {
  if (book.score === "fav") {
    return "‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è";
  }
  const stars = "‚òÖ".repeat(book.score);
  const emptyStars = "‚òÜ".repeat(5 - book.score);
  return stars + emptyStars;
};

const scoreEmoji = renderScoreEmoji();

// Build breadcrumbs
const breadcrumbs: BreadcrumbItem[] = [
  { label: t(lang, "pages.home"), url: `/${lang}` },
  { label: t(lang, "pages.books"), url: buildBooksIndexUrl(lang) },
  { label: book.title }, // Current page, no URL
];

// Share component data
const baseUrl = t(lang, "metaData.url");
const currentUrl = new URL(Astro.url.pathname, baseUrl).href;
const twitterUsername = t(lang, "metaData.twitterUsername");

// Build JSON-LD schema for book
const bookSchema: Record<string, unknown> = {
  "@context": "https://schema.org",
  "@type": "Book",
  name: book.title,
  author: {
    "@type": "Person",
    name: author?.data.name || book.author,
  },
  inLanguage: "es",
  review: {
    "@type": "Review",
    reviewRating: {
      "@type": "Rating",
      ratingValue: book.score === "fav" ? 5 : book.score,
      bestRating: 5,
    },
    author: {
      "@type": "Person",
      name: t(lang, "title"),
    },
    datePublished: book.date.toISOString(),
  },
};

// Add optional fields
if (book.isbn) bookSchema.isbn = book.isbn;
if (book.pages) bookSchema.numberOfPages = book.pages;
if (publisher) {
  bookSchema.publisher = {
    "@type": "Organization",
    name: publisher.data.name,
  };
}
---

<Layout
  lang={lang}
  title={`${book.title} - ${t(lang, "book.review")}`}
  contact={contact}
  translationSlug={book.i18n}
  image={book.book_cover || book.cover}
  type="book"
  schema={bookSchema}
>
  <Breadcrumbs items={breadcrumbs} lang={lang} />
  <main class="book">
    <section class="book__content">
      <div class="book__content__cover">
        <img src={book.book_cover || book.cover} alt={book.title} />
        <div class="score">{scoreEmoji}</div>
      </div>
      <div class="book__content__content">
        <!-- Pagefind title meta -->
        <span data-pagefind-meta="title" style="display: none;">{book.title}</span>
        <PostTitle title={book.title} date={book.date} lang={lang} />
        <div class="book__content__content__data">
          <div class="book__content__content__data_pages">
            <strong>P√°ginas</strong>: {book.pages}
          </div>
          <div class="book__content__content__data__isbn">
            {
              book.isbn ? (
                <>
                  <strong>ISBN</strong>: {book.isbn}
                </>
              ) : book.asin ? (
                <>
                  <strong>ASIN</strong>: {book.asin}
                </>
              ) : null
            }
          </div>
          {
            book.buy && book.buy.length > 0 && (
              <div class="book__content__content__data__buy">
                <strong>Comprar</strong>:
                <ul>
                  {book.buy.map((buyLink) => (
                    <li>
                      <a href={buyLink.link} target="_blank" rel="nofollow">
                        {buyLink.type === "paper" ? "Papel" : buyLink.type === "ebook" ? "eBook" : "Audiolibro"}
                      </a>
                    </li>
                  ))}
                </ul>
              </div>
            )
          }
          {
            publisher && (
              <div class="book__content__content__data__publisher">
                <strong>Editorial</strong>:
                <ul>
                  <li>
                    <a href={buildPublisherUrl(lang, publisher.data.publisher_slug)}>{publisher.data.name}</a>
                  </li>
                  {book.book_card && (
                    <li>
                      <a href={book.book_card} target="_blank" rel="nofollow">
                        Ficha del libro
                      </a>
                    </li>
                  )}
                </ul>
              </div>
            )
          }
        </div>
        <SectionTitle title="Sinopsis" />
        <div class="text-area">
          <p>{book.synopsis}</p>
        </div>
        <div data-pagefind-ignore>
          {author && <SectionTitle title={authorWithGender} />}
          {author && <AuthorInfo author={author} border={false} />}
        </div>
        <SectionTitle title="Rese√±a" />
        <div class="text-area">
          <Content />
        </div>
      </div>
    </section>
    <section class="book__info" data-pagefind-ignore>
      <div class="book__info__icon">üìö</div>
      <ul class="book__info__text">
        {
          author && (
            <li>
              <a href={buildAuthorUrl(lang, author.data.author_slug)} title={authorWithGender}>
                {author.data.name}
              </a>
            </li>
          )
        }
        {
          publisher && (
            <li>
              <a href={buildPublisherUrl(lang, publisher.data.publisher_slug)}>{publisher.data.name}</a>
            </li>
          )
        }
        <li>
          <a href={buildScoreUrl(lang, book.score)} title="Puntuaci√≥n">
            {book.score === "fav" ? "Favorito" : `${book.score}/5`}
          </a>
        </li>
      </ul>
    </section>
    <section class="book__info" data-pagefind-ignore>
      <div class="book__info__icon">üè∑Ô∏è</div>
      <ul class="book__info__text">
        {
          categories.map((category) => (
            <li>
              <a
                href={buildCategoryUrl(lang, category.data.category_slug)}
                class="book__info__text__item"
                title="Categor√≠a"
              >
                {category.data.name}
              </a>
            </li>
          ))
        }
      </ul>
    </section>
    {
      genres.length > 0 && (
        <section class="book__info" data-pagefind-ignore>
          <div class="book__info__icon">üîñ</div>
          <ul class="book__info__text">
            {genres.map((genre) => (
              <li>
                <a href={buildGenreUrl(lang, genre.data.genre_slug)} title="G√©nero">
                  {genre.data.name}
                </a>
              </li>
            ))}
          </ul>
        </section>
      )
    }
  </main>
  <Share title={book.title} url={currentUrl} lang={lang} twitterUsername={twitterUsername} />
</Layout>
