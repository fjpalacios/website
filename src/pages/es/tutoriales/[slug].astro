---
import PostTitle from "@components/PostTitle.astro";
import Share from "@components/Share.astro";
import Layout from "@layouts/Layout.astro";
import { t } from "@locales";
import { buildCategoryUrl, buildTagUrl, buildCourseUrl } from "@utils/routes";
import { getCollection, render } from "astro:content";

import contactEs from "@/content/static/contact/es.json";
import { generateTutorialDetailPaths } from "@/utils/tutorialsPages";

export async function getStaticPaths() {
  const paths = await generateTutorialDetailPaths("es", contactEs);
  return paths.map(({ slug, props }) => ({
    params: { slug },
    props,
  }));
}

const { tutorialEntry, lang, contact } = Astro.props;
const tutorial = tutorialEntry.data;
const { Content } = await render(tutorialEntry);

// Cover image with fallback
const coverImage = tutorial.cover || `/images/defaults/tutorial-default.jpg`;

// Get course info if exists
const allCourses = tutorial.course ? await getCollection("courses") : [];
const course = tutorial.course ? allCourses.find((c) => c.data.course_slug === tutorial.course) : null;

// Share component data
const baseUrl = t(lang, "metaData.url");
const currentUrl = new URL(Astro.url.pathname, baseUrl).href;
const twitterUsername = t(lang, "metaData.twitterUsername");

// Build JSON-LD schema for tutorial article
const tutorialSchema: Record<string, unknown> = {
  "@context": "https://schema.org",
  "@type": "TechArticle",
  headline: tutorial.title,
  description: tutorial.excerpt,
  image: coverImage,
  datePublished: tutorial.date.toISOString(),
  author: {
    "@type": "Person",
    name: t(lang, "title"),
  },
  publisher: {
    "@type": "Person",
    name: t(lang, "title"),
  },
  inLanguage: "es",
};

// Add modified date if available
if (tutorial.updated) {
  tutorialSchema.dateModified = tutorial.updated.toISOString();
}

// Add course as part of series if available
if (course) {
  tutorialSchema.isPartOf = {
    "@type": "CreativeWorkSeries",
    name: course.data.name,
  };
}
---

<Layout
  lang={lang}
  title={tutorial.title}
  description={tutorial.excerpt}
  contact={contact}
  translationSlug={tutorial.i18n}
  image={coverImage}
  type="article"
  schema={tutorialSchema}
>
  <main class="tutorial">
    <section class="tutorial__content">
      <div class="cover-image-wrapper">
        <img src={coverImage} alt={tutorial.title} loading="lazy" />
      </div>
      <PostTitle title={tutorial.title} date={tutorial.date} lang={lang} />
      <div class="text-area">
        <Content />
      </div>
    </section>

    {
      course && (
        <section class="tutorial__info">
          <div class="tutorial__info__icon">üéì</div>
          <ul class="tutorial__info__text">
            <li>
              <a href={buildCourseUrl(lang, course.data.course_slug)} title="Course">
                {course.data.name}
              </a>
            </li>
          </ul>
        </section>
      )
    }

    <section class="tutorial__info">
      <div class="tutorial__info__icon">üè∑Ô∏è</div>
      <ul class="tutorial__info__text">
        <li>
          <a href={buildCategoryUrl(lang, tutorial.category)} class="tutorial__info__text__item" title="Category">
            {t(lang, `categories.${tutorial.category}`)}
          </a>
        </li>
      </ul>
    </section>

    {
      tutorial.tags && tutorial.tags.length > 0 && (
        <section class="tutorial__info">
          <div class="tutorial__info__icon">üîñ</div>
          <ul class="tutorial__info__text">
            {tutorial.tags.map((tag) => (
              <li>
                <a href={buildTagUrl(lang, tag)} class="tutorial__info__text__item" title="Tag">
                  {tag}
                </a>
              </li>
            ))}
          </ul>
        </section>
      )
    }
  </main>
  <Share title={tutorial.title} url={currentUrl} lang={lang} twitterUsername={twitterUsername} />
</Layout>
