---
import Layout from "@layouts/Layout.astro";
import { getCollection, render } from "astro:content";

import contactEs from "@/content/static/contact/es.json";
import { findAuthorBySlug, findPublisherBySlug, findGenresBySlug } from "@/utils/blog";

export async function getStaticPaths() {
  const books = await getCollection("books");

  return books.map((book) => ({
    params: { slug: book.data.post_slug },
    props: { bookEntry: book },
  }));
}

const { bookEntry } = Astro.props;
const book = bookEntry.data;
const { Content } = await render(bookEntry);

// Get related data
const allAuthors = await getCollection("authors");
const allPublishers = await getCollection("publishers");
const allGenres = await getCollection("genres");

const author = findAuthorBySlug(allAuthors, book.author);
const publisher = findPublisherBySlug(allPublishers, book.publisher);
const genres = findGenresBySlug(allGenres, book.genres);

const formattedDate = book.date.toLocaleDateString(book.language === "es" ? "es-ES" : "en-US", {
  year: "numeric",
  month: "long",
  day: "numeric",
});

const displayRating = book.score === "fav" ? "❤️❤️❤️❤️❤️" : "⭐".repeat(book.score);
const ratingClass = book.score === "fav" ? "book__score--fav" : "";
const ratingText = book.score === "fav" ? "Favorite" : `${book.score}/5`;
---

<Layout lang={book.language} title={`${book.title} - Book Review`} contact={contactEs}>
  <a href="/libros" class="back-link">← Back to books</a>

  <div class="book__header">
    <h1 class="book__title">{book.title}</h1>
    <div class="book__meta">Published on {formattedDate}</div>

    <div class="book__info">
      {
        author && (
          <div class="book__info-item">
            <div class="book__info-label">Author</div>
            <div class="book__info-value">
              <a href={`/autor/${author.data.author_slug}`}>{author.data.name}</a>
            </div>
          </div>
        )
      }

      {
        publisher && (
          <div class="book__info-item">
            <div class="book__info-label">Publisher</div>
            <div class="book__info-value">{publisher.data.name}</div>
          </div>
        )
      }

      <div class="book__info-item">
        <div class="book__info-label">Pages</div>
        <div class="book__info-value">{book.pages}</div>
      </div>

      <div class="book__info-item">
        <div class="book__info-label">Rating</div>
        <div class:list={["book__info-value", "book__score", ratingClass]}>
          {displayRating}
          {ratingText}
        </div>
      </div>

      {
        book.isbn && (
          <div class="book__info-item">
            <div class="book__info-label">ISBN</div>
            <div class="book__info-value">{book.isbn}</div>
          </div>
        )
      }

      {
        book.asin && !book.isbn && (
          <div class="book__info-item">
            <div class="book__info-label">ASIN</div>
            <div class="book__info-value">{book.asin}</div>
          </div>
        )
      }
    </div>

    {
      genres.length > 0 && (
        <div class="book__genres">
          {genres.map((genre) => (
            <span class="book__genre-tag">{genre.data.name}</span>
          ))}
        </div>
      )
    }
  </div>

  {
    book.synopsis && (
      <div class="book__synopsis">
        <h2 class="book__synopsis-title">Synopsis</h2>
        <p class="book__synopsis-text">{book.synopsis}</p>
      </div>
    )
  }

  <div class="book__content">
    <Content />
  </div>

  {
    book.buy_links && book.buy_links.length > 0 && (
      <div class="book__buy-links">
        <h2 class="book__buy-links-title">Buy this book</h2>
        <div class="book__buy-links-list">
          {book.buy_links.map((link) => (
            <a href={link.url} target="_blank" rel="noopener noreferrer" class="book__buy-link">
              {link.name}
            </a>
          ))}
        </div>
      </div>
    )
  }
</Layout>

<style>
  .back-link {
    display: inline-block;
    color: var(--accent);
    text-decoration: none;
    margin-bottom: 2rem;
    font-size: 0.95rem;
  }

  .back-link:hover {
    text-decoration: underline;
  }
</style>
