---
import PostList from "@components/PostList.astro";
import Title from "@components/Title.astro";
import Layout from "@layouts/Layout.astro";
import { getCollection } from "astro:content";

import contactEs from "@/content/static/contact/es.json";
import {
  sortByDate,
  filterByLanguage,
  paginateItems,
  getPageCount,
  findAuthorBySlug,
  prepareBookSummary,
  type BookSummary,
} from "@/utils/blog";

const BOOKS_PER_PAGE = 12;

// Get all books and authors
const allBooks = await getCollection("books");
const allAuthors = await getCollection("authors");

// Filter by Spanish language (default for the site)
const spanishBooks = filterByLanguage(allBooks, "es");

// Sort by date (newest first)
const sortedBooks = sortByDate(spanishBooks, "desc");

// Prepare book summaries with author info
const bookSummaries: BookSummary[] = sortedBooks.map((book) => {
  const author = findAuthorBySlug(allAuthors, book.data.author);
  return prepareBookSummary(book, author);
});

// Paginate
const currentPage = 1;
const totalPages = getPageCount(bookSummaries.length, BOOKS_PER_PAGE);
const paginatedBooks = paginateItems(bookSummaries, currentPage, BOOKS_PER_PAGE);
---

<Layout lang="es" title="Libros - Book Reviews" contact={contactEs}>
  <Title title="ðŸ“š Libros" />

  <PostList posts={paginatedBooks} />

  {
    totalPages > 1 && (
      <div class="pagination">
        {Array.from({ length: totalPages }, (_, i) => i + 1).map((page) => (
          <a
            href={page === 1 ? "/libros" : `/libros/page/${page}`}
            class:list={["page-link", { active: page === currentPage }]}
          >
            {page}
          </a>
        ))}
      </div>
    )
  }
</Layout>
