---
import Layout from "@layouts/Layout.astro";
import { getCollection, render } from "astro:content";

import contactEn from "@/content/static/contact/en.json";
import contactEs from "@/content/static/contact/es.json";

export async function getStaticPaths() {
  const tutorials = await getCollection("tutorials");

  return tutorials.map((tutorial) => ({
    params: { slug: tutorial.data.post_slug },
    props: { tutorialEntry: tutorial },
  }));
}

const { tutorialEntry } = Astro.props;
const tutorial = tutorialEntry.data;
const { Content } = await render(tutorialEntry);

const lang = tutorial.language;
const contact = lang === "es" ? contactEs : contactEn;

const formattedDate = tutorial.date.toLocaleDateString(lang === "es" ? "es-ES" : "en-US", {
  year: "numeric",
  month: "long",
  day: "numeric",
});

const formatTime = (minutes: number): string => {
  if (minutes < 60) return `${minutes} min`;
  const hours = Math.floor(minutes / 60);
  const remainingMinutes = minutes % 60;
  return remainingMinutes > 0 ? `${hours}h ${remainingMinutes}min` : `${hours}h`;
};

const difficultyLabels = {
  es: {
    beginner: "Principiante",
    intermediate: "Intermedio",
    advanced: "Avanzado",
  },
  en: {
    beginner: "Beginner",
    intermediate: "Intermediate",
    advanced: "Advanced",
  },
};

const difficultyLabel = difficultyLabels[lang][tutorial.difficulty];
---

<Layout lang={lang} title={tutorial.title} description={tutorial.excerpt} contact={contact}>
  <article class="tutorial">
    <header class="tutorial__header">
      <div class="tutorial__badges">
        <span class={`tutorial__difficulty tutorial__difficulty--${tutorial.difficulty}`}>
          {difficultyLabel}
        </span>
        <span class="tutorial__time">
          ‚è±Ô∏è {formatTime(tutorial.estimated_time)}
        </span>
      </div>

      <h1 class="tutorial__title">{tutorial.title}</h1>

      <div class="tutorial__meta">
        <time datetime={tutorial.date.toISOString()}>{formattedDate}</time>
      </div>

      {
        (tutorial.github_repo || tutorial.demo_url) && (
          <div class="tutorial__links">
            {tutorial.github_repo && (
              <a href={tutorial.github_repo} target="_blank" rel="noopener noreferrer">
                <span>üîó</span> View on GitHub
              </a>
            )}
            {tutorial.demo_url && (
              <a href={tutorial.demo_url} target="_blank" rel="noopener noreferrer">
                <span>üöÄ</span> View Demo
              </a>
            )}
          </div>
        )
      }
    </header>

    <div class="tutorial__content">
      <Content />
    </div>

    {
      tutorial.tags.length > 0 && (
        <footer class="tutorial__footer">
          <div class="tutorial__tags">
            <i class="icon-tag" />
            <ul class="tutorial__tags-list">
              {tutorial.tags.map((tag) => (
                <li>
                  <span class="tag">{tag}</span>
                </li>
              ))}
            </ul>
          </div>
        </footer>
      )
    }
  </article>
</Layout>
