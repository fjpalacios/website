---
import PostTitle from "@components/PostTitle.astro";
import Layout from "@layouts/Layout.astro";
import { getCollection, render } from "astro:content";

import contactEn from "@/content/static/contact/en.json";
import contactEs from "@/content/static/contact/es.json";

export async function getStaticPaths() {
  const tutorials = await getCollection("tutorials");

  return tutorials.map((tutorial) => ({
    params: { slug: tutorial.data.post_slug },
    props: { tutorialEntry: tutorial },
  }));
}

const { tutorialEntry } = Astro.props;
const tutorial = tutorialEntry.data;
const { Content } = await render(tutorialEntry);

const lang = tutorial.language;
const contact = lang === "es" ? contactEs : contactEn;

// Cover image with fallback
const coverImage = tutorial.cover || `/images/defaults/tutorial-default.jpg`;

// Get course info if exists
const allCourses = tutorial.course ? await getCollection("courses") : [];
const course = tutorial.course ? allCourses.find((c) => c.data.course_slug === tutorial.course) : null;

// Get categories
const allCategories = await getCollection("categories");
const categories = allCategories.filter((cat) => tutorial.categories?.includes(cat.data.category_slug));
---

<Layout lang={lang} title={tutorial.title} description={tutorial.excerpt} contact={contact}>
  <main class="tutorial">
    <section class="tutorial__content">
      <img src={coverImage} alt={tutorial.title} width="1400" height="700" loading="lazy" />
      <PostTitle title={tutorial.title} date={tutorial.date} />
      <div class="text-area">
        <Content />
      </div>
    </section>

    {
      course && (
        <section class="tutorial__info">
          <div class="tutorial__info__icon">
            <i class="icon-course" />
          </div>
          <ul class="tutorial__info__text">
            <li>
              <a href={`/course/${course.data.course_slug}`} title="Course">
                {course.data.name}
              </a>
            </li>
          </ul>
        </section>
      )
    }

    {
      categories.length > 0 && (
        <section class="tutorial__info">
          <div class="tutorial__info__icon">
            <i class="icon-tag" />
          </div>
          <ul class="tutorial__info__text">
            {categories.map((category) => (
              <li>
                <a
                  href={`/category/${category.data.category_slug}`}
                  class="tutorial__info__text__item"
                  title="Category"
                >
                  {category.data.name}
                </a>
              </li>
            ))}
          </ul>
        </section>
      )
    }
  </main>
</Layout>
